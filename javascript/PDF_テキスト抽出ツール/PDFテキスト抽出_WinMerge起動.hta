<html>
<head>
    <title>PDF テキスト抽出ツール（WinMerge自動起動）</title>
    <HTA:APPLICATION
        ID="PDFTextExtractor"
        APPLICATIONNAME="PDFテキスト抽出ツール"
        BORDER="thick"
        BORDERSTYLE="normal"
        CAPTION="yes"
        CONTEXTMENU="yes"
        ICON=""
        INNERBORDER="yes"
        MAXIMIZEBUTTON="yes"
        MINIMIZEBUTTON="yes"
        NAVIGABLE="no"
        SCROLL="auto"
        SCROLLFLAT="no"
        SELECTION="yes"
        SHOWINTASKBAR="yes"
        SINGLEINSTANCE="no"
        SYSMENU="yes"
        VERSION="1.0"
        WINDOWSTATE="normal"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', 'Meiryo', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }

        h1 {
            color: #4fc3f7;
            font-size: 1.3em;
            margin-bottom: 20px;
            text-align: center;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .file-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-box {
            flex: 1;
            background: #252526;
            border: 2px dashed #555;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .file-box.loaded {
            border-color: #4caf50;
            background: #1e3d1e;
        }

        .file-box label {
            display: block;
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .file-box input[type="file"] {
            margin-bottom: 10px;
        }

        .file-box .filename {
            color: #4caf50;
            font-size: 0.9em;
            word-break: break-all;
        }

        .file-box .status {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .settings {
            background: #252526;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
        }

        .settings label {
            color: #4fc3f7;
            display: block;
            margin-bottom: 8px;
        }

        .settings input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-size: 0.95em;
        }

        .settings .hint {
            color: #888;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .button-area {
            text-align: center;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin: 5px;
        }

        .btn-primary {
            background: #4fc3f7;
            color: #000;
        }

        .btn-primary:hover {
            background: #29b6f6;
        }

        .btn-primary:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #555;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #666;
        }

        .log-area {
            background: #252526;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Consolas', 'MS Gothic', monospace;
            font-size: 0.85em;
        }

        .log-area .log-entry {
            margin-bottom: 3px;
        }

        .log-area .info { color: #4fc3f7; }
        .log-area .success { color: #4caf50; }
        .log-area .error { color: #f44336; }
        .log-area .warn { color: #ff9800; }

        .usage {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 20px;
        }

        .usage h3 {
            color: #4fc3f7;
            font-size: 0.95em;
            margin-bottom: 10px;
        }

        .usage ol {
            color: #aaa;
            font-size: 0.85em;
            padding-left: 20px;
        }

        .usage li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF テキスト抽出ツール（WinMerge自動起動）</h1>

        <div class="file-section">
            <div class="file-box" id="box1">
                <label>旧PDF（比較元）</label>
                <input type="file" id="file1" accept=".pdf" onchange="handleFile(1)">
                <div class="filename" id="filename1"></div>
                <div class="status" id="status1"></div>
            </div>
            <div class="file-box" id="box2">
                <label>新PDF（比較先）</label>
                <input type="file" id="file2" accept=".pdf" onchange="handleFile(2)">
                <div class="filename" id="filename2"></div>
                <div class="status" id="status2"></div>
            </div>
        </div>

        <div class="settings">
            <label>WinMerge パス:</label>
            <input type="text" id="winmergePath" value="C:\Program Files\WinMerge\WinMergeU.exe">
            <div class="hint">WinMergeがインストールされているパスを指定してください</div>
        </div>

        <div class="button-area">
            <button class="btn btn-primary" id="btnCompare" onclick="extractAndCompare()" disabled>
                テキスト抽出してWinMergeで比較
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                クリア
            </button>
        </div>

        <div class="log-area" id="logArea"></div>

        <div class="usage">
            <h3>使い方</h3>
            <ol>
                <li>2つのPDFファイルを選択</li>
                <li>「テキスト抽出してWinMergeで比較」ボタンをクリック</li>
                <li>自動的にテキスト抽出 → 一時ファイル保存 → WinMerge起動</li>
            </ol>
        </div>
    </div>

    <script>
        // グローバル変数
        var fileData = { 1: null, 2: null };
        var fileNames = { 1: '', 2: '' };
        var extractedTexts = { 1: null, 2: null };

        // ログ出力
        function log(message, type) {
            var logArea = document.getElementById('logArea');
            var entry = document.createElement('div');
            entry.className = 'log-entry ' + (type || 'info');
            var timestamp = '[' + new Date().toLocaleTimeString() + '] ';
            entry.appendChild(document.createTextNode(timestamp + message));
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ファイル選択処理
        function handleFile(num) {
            var fileInput = document.getElementById('file' + num);
            var file = fileInput.files[0];

            if (!file) return;

            fileNames[num] = file.name.replace('.pdf', '');
            document.getElementById('filename' + num).innerText = file.name;
            document.getElementById('box' + num).className = 'file-box loaded';

            log('ファイル選択: ' + file.name, 'info');

            // FileReaderでArrayBufferとして読み込み
            var reader = new FileReader();
            reader.onload = function(e) {
                fileData[num] = new Uint8Array(e.target.result);
                document.getElementById('status' + num).innerText = '読み込み完了';
                log(file.name + ' の読み込み完了', 'success');
                updateButtons();
            };
            reader.onerror = function() {
                log('ファイル読み込みエラー: ' + file.name, 'error');
            };
            reader.readAsArrayBuffer(file);
        }

        // ボタン状態更新
        function updateButtons() {
            var btn = document.getElementById('btnCompare');
            btn.disabled = !(fileData[1] && fileData[2]);
        }

        // PDF.jsでテキスト抽出
        function extractTextFromPdf(data, callback) {
            if (typeof pdfjsLib === 'undefined') {
                callback('PDF.jsライブラリが読み込まれていません', null);
                return;
            }

            pdfjsLib.GlobalWorkerOptions.workerSrc = '';

            var loadingTask = pdfjsLib.getDocument({ data: data });
            loadingTask.promise.then(function(pdf) {
                var totalPages = pdf.numPages;
                var fullText = '';
                var pagesProcessed = 0;

                function processPage(pageNum) {
                    pdf.getPage(pageNum).then(function(page) {
                        page.getTextContent().then(function(textContent) {
                            if (pageNum > 1) {
                                fullText += '\n\n--- ページ ' + pageNum + ' ---\n\n';
                            } else {
                                fullText += '--- ページ ' + pageNum + ' ---\n\n';
                            }

                            var lastY = null;
                            var lineText = '';

                            for (var i = 0; i < textContent.items.length; i++) {
                                var item = textContent.items[i];
                                if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                                    fullText += lineText + '\n';
                                    lineText = '';
                                }
                                lineText += item.str;
                                lastY = item.transform[5];
                            }

                            if (lineText) {
                                fullText += lineText + '\n';
                            }

                            pagesProcessed++;
                            log('ページ ' + pageNum + ' / ' + totalPages + ' 処理完了', 'info');

                            if (pagesProcessed === totalPages) {
                                callback(null, fullText);
                            } else {
                                processPage(pageNum + 1);
                            }
                        });
                    });
                }

                processPage(1);
            }).catch(function(err) {
                callback('PDF読み込みエラー: ' + err.message, null);
            });
        }

        // テキスト抽出してWinMergeで比較
        function extractAndCompare() {
            log('処理開始...', 'info');

            // まず旧PDFを処理
            log('旧PDF テキスト抽出中...', 'info');
            extractTextFromPdf(fileData[1], function(err1, text1) {
                if (err1) {
                    log(err1, 'error');
                    return;
                }

                extractedTexts[1] = text1;
                log('旧PDF テキスト抽出完了', 'success');

                // 次に新PDFを処理
                log('新PDF テキスト抽出中...', 'info');
                extractTextFromPdf(fileData[2], function(err2, text2) {
                    if (err2) {
                        log(err2, 'error');
                        return;
                    }

                    extractedTexts[2] = text2;
                    log('新PDF テキスト抽出完了', 'success');

                    // 一時ファイルに保存してWinMerge起動
                    saveAndLaunchWinMerge();
                });
            });
        }

        // 一時ファイル保存とWinMerge起動
        function saveAndLaunchWinMerge() {
            try {
                var fso = new ActiveXObject('Scripting.FileSystemObject');
                var shell = new ActiveXObject('WScript.Shell');

                // 一時フォルダを取得
                var tempFolder = fso.GetSpecialFolder(2).Path;  // 2 = TemporaryFolder

                // ファイルパス
                var file1Path = tempFolder + '\\' + fileNames[1] + '_旧.txt';
                var file2Path = tempFolder + '\\' + fileNames[2] + '_新.txt';

                // BOM付きUTF-8で保存
                log('一時ファイル保存中...', 'info');

                // ADODB.Streamを使用してUTF-8で保存
                saveUtf8File(file1Path, extractedTexts[1]);
                saveUtf8File(file2Path, extractedTexts[2]);

                log('保存完了: ' + file1Path, 'success');
                log('保存完了: ' + file2Path, 'success');

                // WinMerge起動
                var winmergePath = document.getElementById('winmergePath').value;

                if (!fso.FileExists(winmergePath)) {
                    log('WinMergeが見つかりません: ' + winmergePath, 'error');
                    log('WinMergeのパスを確認してください', 'warn');
                    return;
                }

                log('WinMerge起動中...', 'info');
                var cmd = '"' + winmergePath + '" "' + file1Path + '" "' + file2Path + '"';
                shell.Run(cmd, 1, false);

                log('WinMergeを起動しました', 'success');

            } catch (e) {
                log('エラー: ' + e.message, 'error');
            }
        }

        // UTF-8でファイル保存
        function saveUtf8File(path, content) {
            var stream = new ActiveXObject('ADODB.Stream');
            stream.Type = 2;  // adTypeText
            stream.Charset = 'UTF-8';
            stream.Open();
            stream.WriteText(content);
            stream.SaveToFile(path, 2);  // 2 = adSaveCreateOverWrite
            stream.Close();
        }

        // クリア
        function clearAll() {
            fileData = { 1: null, 2: null };
            fileNames = { 1: '', 2: '' };
            extractedTexts = { 1: null, 2: null };

            for (var i = 1; i <= 2; i++) {
                document.getElementById('file' + i).value = '';
                document.getElementById('filename' + i).innerText = '';
                document.getElementById('status' + i).innerText = '';
                document.getElementById('box' + i).className = 'file-box';
            }

            // ログエリアをクリア（DOM操作で安全に）
            var logArea = document.getElementById('logArea');
            while (logArea.firstChild) {
                logArea.removeChild(logArea.firstChild);
            }

            updateButtons();
            log('クリアしました', 'info');
        }

        // 初期化
        window.onload = function() {
            log('PDF テキスト抽出ツール 起動', 'info');

            if (typeof pdfjsLib !== 'undefined') {
                log('PDF.js 読み込み完了', 'success');
            } else {
                log('PDF.js 読み込み失敗 - インターネット接続を確認してください', 'error');
            }
        };
    </script>
</body>
</html>

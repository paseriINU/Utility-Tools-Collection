<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF テキスト抽出ツール（WinMerge用）</title>
    <script>
        // ライブラリロード状態の初期化
        window.pdfJsLoaded = false;
        window.pdfJsSource = '初期化中';
    </script>
    <!-- CDN優先: オフライン環境では埋め込みにフォールバック -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // CDNロード後の初期化チェック
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = '';
            window.pdfJsLoaded = true;
            window.pdfJsSource = 'CDN';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Yu Gothic UI', 'Meiryo', sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            min-height: 100vh;
        }

        /* ヘッダー */
        .header {
            background: #2d2d2d;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 1.3em;
            color: #4fc3f7;
        }

        .header-info {
            font-size: 0.85em;
            color: #888;
        }

        /* メインコンテナ */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
            padding: 15px;
            gap: 15px;
        }

        /* ドロップエリア */
        .drop-areas {
            display: flex;
            gap: 15px;
            flex: 0 0 auto;
        }

        .drop-zone {
            flex: 1;
            min-height: 120px;
            border: 2px dashed #555;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #252526;
        }

        .drop-zone:hover {
            border-color: #4fc3f7;
            background: #2a2d2e;
        }

        .drop-zone.dragover {
            border-color: #4fc3f7;
            background: #2a3d4e;
        }

        .drop-zone.loaded {
            border-color: #4caf50;
            background: #1e3d1e;
        }

        .drop-zone-label {
            font-size: 1.1em;
            color: #4fc3f7;
            margin-bottom: 8px;
        }

        .drop-zone-text {
            color: #888;
            font-size: 0.9em;
            text-align: center;
        }

        .drop-zone-filename {
            color: #4caf50;
            font-size: 0.85em;
            margin-top: 8px;
            word-break: break-all;
        }

        /* プレビューエリア */
        .preview-areas {
            display: flex;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }

        .preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #252526;
            border-radius: 8px;
            overflow: hidden;
        }

        .preview-header {
            background: #2d2d2d;
            padding: 10px 15px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            color: #4fc3f7;
            font-size: 0.95em;
        }

        .preview-stats {
            color: #888;
            font-size: 0.8em;
        }

        .preview-content {
            flex: 1;
            overflow: auto;
            padding: 15px;
            font-family: 'Consolas', 'MS Gothic', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #d4d4d4;
        }

        .preview-placeholder {
            color: #666;
            text-align: center;
            padding: 40px;
        }

        /* ボタンエリア */
        .button-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 8px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4fc3f7;
            color: #000;
        }

        .btn-primary:hover:not(:disabled) {
            background: #29b6f6;
        }

        .btn-secondary {
            background: #555;
            color: #fff;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #666;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 使い方セクション */
        .usage-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: auto;
        }

        .usage-title {
            color: #4fc3f7;
            font-size: 0.95em;
            margin-bottom: 10px;
        }

        .usage-steps {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .usage-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .step-number {
            background: #4fc3f7;
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-text {
            color: #aaa;
            font-size: 0.85em;
            line-height: 1.5;
        }

        /* ローディング */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading.active {
            display: flex;
        }

        .loading-content {
            background: #2d2d2d;
            padding: 30px 50px;
            border-radius: 8px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #555;
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 隠しinput */
        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PDF テキスト抽出ツール（WinMerge用）</h1>
        <div class="header-info">
            PDF.js: <span id="pdfjs-status">確認中...</span>
        </div>
    </div>

    <div class="main-container">
        <!-- ドロップエリア -->
        <div class="drop-areas">
            <div class="drop-zone" id="dropZone1" onclick="document.getElementById('fileInput1').click()">
                <div class="drop-zone-label">旧PDF（比較元）</div>
                <div class="drop-zone-text">クリックまたはドラッグ&ドロップ</div>
                <div class="drop-zone-filename" id="filename1"></div>
            </div>
            <div class="drop-zone" id="dropZone2" onclick="document.getElementById('fileInput2').click()">
                <div class="drop-zone-label">新PDF（比較先）</div>
                <div class="drop-zone-text">クリックまたはドラッグ&ドロップ</div>
                <div class="drop-zone-filename" id="filename2"></div>
            </div>
        </div>

        <!-- 隠しファイル入力 -->
        <input type="file" id="fileInput1" class="hidden-input" accept=".pdf">
        <input type="file" id="fileInput2" class="hidden-input" accept=".pdf">

        <!-- プレビューエリア -->
        <div class="preview-areas">
            <div class="preview-panel">
                <div class="preview-header">
                    <span class="preview-title">旧PDF テキスト</span>
                    <span class="preview-stats" id="stats1"></span>
                </div>
                <div class="preview-content" id="preview1">
                    <div class="preview-placeholder">PDFを読み込むとテキストが表示されます</div>
                </div>
            </div>
            <div class="preview-panel">
                <div class="preview-header">
                    <span class="preview-title">新PDF テキスト</span>
                    <span class="preview-stats" id="stats2"></span>
                </div>
                <div class="preview-content" id="preview2">
                    <div class="preview-placeholder">PDFを読み込むとテキストが表示されます</div>
                </div>
            </div>
        </div>

        <!-- ボタンエリア -->
        <div class="button-area">
            <button class="btn btn-primary" id="btnDownload1" disabled onclick="downloadText(1)">
                旧PDFテキストをダウンロード
            </button>
            <button class="btn btn-primary" id="btnDownload2" disabled onclick="downloadText(2)">
                新PDFテキストをダウンロード
            </button>
            <button class="btn btn-secondary" id="btnDownloadBoth" disabled onclick="downloadBoth()">
                両方をダウンロード
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                クリア
            </button>
        </div>

        <!-- 使い方 -->
        <div class="usage-section">
            <div class="usage-title">WinMergeでの比較手順</div>
            <div class="usage-steps">
                <div class="usage-step">
                    <div class="step-number">1</div>
                    <div class="step-text">2つのPDFをドロップ</div>
                </div>
                <div class="usage-step">
                    <div class="step-number">2</div>
                    <div class="step-text">「両方をダウンロード」をクリック</div>
                </div>
                <div class="usage-step">
                    <div class="step-number">3</div>
                    <div class="step-text">ダウンロードした2つのテキストファイルをWinMergeで開く</div>
                </div>
                <div class="usage-step">
                    <div class="step-number">4</div>
                    <div class="step-text">テキストベースで正確な差分を確認</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ローディング -->
    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loadingText">テキスト抽出中...</div>
        </div>
    </div>

    <script>
        //==============================================================================
        // グローバル変数
        //==============================================================================

        // 抽出したテキストデータを保持
        let extractedTexts = {
            1: null,  // 旧PDF
            2: null   // 新PDF
        };

        // ファイル名を保持
        let fileNames = {
            1: '',
            2: ''
        };

        //==============================================================================
        // 初期化
        //==============================================================================

        document.addEventListener('DOMContentLoaded', function() {
            // PDF.jsの状態を確認
            checkPdfJsStatus();

            // ドロップゾーンのイベント設定
            setupDropZone('dropZone1', 'fileInput1', 1);
            setupDropZone('dropZone2', 'fileInput2', 2);

            // ファイル入力のイベント設定
            document.getElementById('fileInput1').addEventListener('change', function(e) {
                if (e.target.files[0]) handleFile(e.target.files[0], 1);
            });
            document.getElementById('fileInput2').addEventListener('change', function(e) {
                if (e.target.files[0]) handleFile(e.target.files[0], 2);
            });
        });

        //==============================================================================
        // PDF.js 状態確認
        //==============================================================================

        function checkPdfJsStatus() {
            const statusEl = document.getElementById('pdfjs-status');
            if (typeof pdfjsLib !== 'undefined') {
                statusEl.textContent = '読み込み完了 (' + window.pdfJsSource + ')';
                statusEl.style.color = '#4caf50';
            } else {
                statusEl.textContent = '読み込み失敗';
                statusEl.style.color = '#f44336';
            }
        }

        //==============================================================================
        // ドロップゾーン設定
        //==============================================================================

        function setupDropZone(zoneId, inputId, num) {
            const zone = document.getElementById(zoneId);

            // ドラッグオーバー
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            // ドラッグリーブ
            zone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                zone.classList.remove('dragover');
            });

            // ドロップ
            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                zone.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFile(files[0], num);
                }
            });
        }

        //==============================================================================
        // ファイル処理
        //==============================================================================

        async function handleFile(file, num) {
            if (!file || file.type !== 'application/pdf') {
                alert('PDFファイルを選択してください');
                return;
            }

            // ファイル名を保存
            fileNames[num] = file.name.replace('.pdf', '');

            // UI更新
            document.getElementById('filename' + num).textContent = file.name;
            document.getElementById('dropZone' + num).classList.add('loaded');

            // ローディング表示
            showLoading('テキスト抽出中... (' + file.name + ')');

            try {
                // ファイルをArrayBufferとして読み込み
                const arrayBuffer = await file.arrayBuffer();

                // PDFからテキスト抽出
                const text = await extractTextFromPdf(arrayBuffer);

                // テキストを保存
                extractedTexts[num] = text;

                // プレビュー表示
                displayPreview(num, text);

                // ボタン有効化
                updateButtons();

            } catch (error) {
                console.error('PDF処理エラー:', error);
                alert('PDFの処理中にエラーが発生しました: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        //==============================================================================
        // PDFテキスト抽出（PDF.js使用）
        //==============================================================================

        async function extractTextFromPdf(arrayBuffer) {
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('PDF.jsライブラリが読み込まれていません');
            }

            // PDFドキュメントを読み込み
            const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer, disableWorker: true });
            const pdf = await loadingTask.promise;

            let fullText = '';
            const totalPages = pdf.numPages;

            // 全ページからテキストを抽出
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                // ローディングテキスト更新
                document.getElementById('loadingText').textContent =
                    'テキスト抽出中... ページ ' + pageNum + ' / ' + totalPages;

                // ページを取得
                const page = await pdf.getPage(pageNum);

                // テキストコンテンツを取得
                const textContent = await page.getTextContent();

                // ページ区切りを追加
                if (pageNum > 1) {
                    fullText += '\n\n--- ページ ' + pageNum + ' ---\n\n';
                } else {
                    fullText += '--- ページ ' + pageNum + ' ---\n\n';
                }

                // テキストアイテムを結合
                // PDF.jsはテキストを小さな断片（items）として返すので、
                // それらを適切に結合する必要がある
                let lastY = null;
                let lineText = '';

                for (const item of textContent.items) {
                    // Y座標が変わったら改行
                    if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                        fullText += lineText.trim() + '\n';
                        lineText = '';
                    }

                    lineText += item.str;
                    lastY = item.transform[5];
                }

                // 最後の行を追加
                if (lineText.trim()) {
                    fullText += lineText.trim() + '\n';
                }
            }

            return fullText;
        }

        //==============================================================================
        // プレビュー表示
        //==============================================================================

        function displayPreview(num, text) {
            const previewEl = document.getElementById('preview' + num);
            const statsEl = document.getElementById('stats' + num);

            // テキストを表示（textContentを使用して安全に設定）
            previewEl.textContent = text;

            // 統計情報
            const lines = text.split('\n').length;
            const chars = text.length;
            statsEl.textContent = lines + ' 行 / ' + chars.toLocaleString() + ' 文字';
        }

        //==============================================================================
        // ボタン状態更新
        //==============================================================================

        function updateButtons() {
            document.getElementById('btnDownload1').disabled = !extractedTexts[1];
            document.getElementById('btnDownload2').disabled = !extractedTexts[2];
            document.getElementById('btnDownloadBoth').disabled = !(extractedTexts[1] && extractedTexts[2]);
        }

        //==============================================================================
        // ダウンロード機能
        //==============================================================================

        function downloadText(num) {
            if (!extractedTexts[num]) return;

            const suffix = num === 1 ? '_旧' : '_新';
            const filename = (fileNames[num] || 'pdf') + suffix + '.txt';

            downloadFile(extractedTexts[num], filename);
        }

        function downloadBoth() {
            if (!extractedTexts[1] || !extractedTexts[2]) return;

            // 両方のファイルをダウンロード
            downloadText(1);
            setTimeout(function() { downloadText(2); }, 500);  // 少し遅延させて順番にダウンロード
        }

        function downloadFile(content, filename) {
            // BOM付きUTF-8でエンコード（Windowsのメモ帳やWinMergeで文字化けしないように）
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, content], { type: 'text/plain;charset=utf-8' });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        //==============================================================================
        // クリア
        //==============================================================================

        function clearAll() {
            extractedTexts = { 1: null, 2: null };
            fileNames = { 1: '', 2: '' };

            // UI リセット
            for (let i = 1; i <= 2; i++) {
                document.getElementById('dropZone' + i).classList.remove('loaded');
                document.getElementById('filename' + i).textContent = '';
                // プレースホルダーをDOM操作で安全に設定
                const previewEl = document.getElementById('preview' + i);
                previewEl.textContent = '';
                const placeholder = document.createElement('div');
                placeholder.className = 'preview-placeholder';
                placeholder.textContent = 'PDFを読み込むとテキストが表示されます';
                previewEl.appendChild(placeholder);
                document.getElementById('stats' + i).textContent = '';
                document.getElementById('fileInput' + i).value = '';
            }

            updateButtons();
        }

        //==============================================================================
        // ローディング表示
        //==============================================================================

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text || 'テキスト抽出中...';
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }
    </script>
</body>
</html>

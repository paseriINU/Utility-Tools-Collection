# JP1 ジョブ管理ツール

Excel VBAでJP1/AJS3のジョブネット一覧を取得し、選択したジョブを順次実行するツールです。

## 概要

- **2つの実行モード**: ローカルモード（このPCのJP1を使用）とリモートモード（WinRM経由）を選択可能
- **ジョブ一覧取得**: `ajsprint`でジョブネット一覧を取得してExcelに表示
- **保留ジョブの可視化**: 保留中のジョブを一覧でハイライト表示（オレンジ色）
- **保留自動解除**: 保留中のジョブを実行する際、`ajsrelease`で自動的に保留解除してから実行
- **選択実行**: チェックしたジョブを実行順で順次起動
- **完了待ち**: `ajsstatus`でジョブ完了を監視（正常終了/異常終了を判定）
- **詳細取得**: `ajsshow`で実行結果の詳細を取得
- **エラー停止**: 1つでも失敗したら処理を中断
- **実行ログ出力**: PowerShell実行履歴をテキストファイルに保存

## 実行モード

| モード | 説明 | 用途 |
|--------|------|------|
| **ローカル** | このPCにインストールされたJP1を使用 | JP1がインストールされた開発PC等で直接実行 |
| **リモート** | WinRM経由でJP1サーバに接続 | JP1サーバがリモートにある場合 |

## 必要な環境

### ローカルモードの場合

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- **JP1/AJS3 - View または Agent**がインストールされていること

### リモートモードの場合

#### ローカルPC（実行する側）

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- **管理者権限**（WinRM設定変更に必要）

#### JP1サーバ（リモート側）

- Windows Server
- JP1/AJS3 - Manager が稼働中
- PowerShell Remotingが有効（`Enable-PSRemoting`済み）
- WinRMサービスが起動中

## セットアップ

### 1. VBAモジュールのインポート

1. 新規Excelブックを作成
2. `Alt + F11` でVBAエディタを開く
3. 「ファイル」→「ファイルのインポート」
4. 以下の2つのファイルをインポート：
   - `JP1_ジョブ管理ツール_Setup.bas` （初期化モジュール）
   - `JP1_ジョブ管理ツール.bas` （メインモジュール）
5. ブックを `.xlsm` 形式で保存

**ファイル構成**:
```
JP1_ジョブ管理ツール/
├── JP1_ジョブ管理ツール_Setup.bas  # 初期化（シート作成・フォーマット）
├── JP1_ジョブ管理ツール.bas        # メイン処理（ジョブ取得・実行）
└── README.md
```

### 2. 初期化

1. `Alt + F8` でマクロ一覧を表示
2. `InitializeJP1Manager` を実行
3. メインシート、ジョブ一覧シート、実行ログシートが作成される

## 使い方

### 1. 接続設定

メインシートで以下を設定：

| 設定項目 | 説明 | 例 |
|---------|------|---|
| **実行モード** | ローカル/リモート | `ローカル` or `リモート` |
| JP1サーバ | JP1サーバのIP/ホスト名（リモートモード時） | `192.168.1.100` |
| リモートユーザー | Windowsログインユーザー（リモートモード時） | `Administrator` |
| リモートパスワード | ※空の場合は実行時に入力（リモートモード時） | |
| JP1ユーザー | JP1ユーザー名 | `jp1admin` |
| JP1パスワード | ※空の場合は実行時に入力 | |
| 取得パス | ジョブネット取得の起点 | `/` (全件) |

**注**: ローカルモードの場合、JP1サーバ・リモートユーザー・リモートパスワードの設定は不要です。

### 2. ジョブ一覧取得

1. 「**ジョブ一覧取得**」ボタンをクリック
2. パスワード入力（設定が空の場合）
3. ジョブ一覧シートにジョブネットが表示される

### 3. 実行ジョブの選択

ジョブ一覧シートで：

- **順序列**: 実行するジョブに実行順を数字で指定（1, 2, 3...）
- 順序が入力されているジョブのみが実行対象となります
- **保留中のジョブ**: オレンジ色でハイライト表示されます

```
| 順序 | ジョブネットパス                    | ジョブネット名    | 保留   |
|:----:|--------------------------------------|-------------------|--------|
|  1   | /main_unit/jobgroup1/daily_batch    | daily_batch       |        |
|      | /main_unit/jobgroup1/weekly_batch   | weekly_batch      | 保留中 | ← オレンジ色でハイライト
|  2   | /main_unit/jobgroup2/monthly_batch  | monthly_batch     | 保留中 | ← オレンジ色でハイライト
```

### 4. ジョブ実行

1. 「**選択ジョブ実行**」ボタンをクリック
2. 確認ダイアログで「はい」を選択
   - 保留中のジョブがある場合は、確認メッセージに表示されます
3. 順序に従ってジョブが順次実行される
   - **保留中のジョブは自動で保留解除**してから実行されます
   - 保留解除に成功すると、ジョブ一覧の保留表示とハイライトが解除されます
4. **1つでも失敗したら処理中断**（保留解除失敗も含む）
5. 結果は実行ログシートに記録される

## 実行設定

| 設定項目 | 説明 | デフォルト |
|---------|------|-----------|
| 完了待ち | ジョブ完了を待つか | はい |
| タイムアウト（秒） | 完了待ちの最大時間（0=無制限） | 0 |
| 状態確認間隔（秒） | ポーリング間隔 | 10 |

## 実行ログファイル

ジョブ実行時のPowerShell実行履歴がテキストファイルに自動保存されます。

### 保存場所

```
[Excelブックのフォルダ]\Logs\JP1_実行ログ_yyyyMMdd_HHmmss.txt
```

- Excelブックと同じフォルダに `Logs` サブフォルダが自動作成されます
- 実行ごとに日時を含むファイル名で新しいログファイルが作成されます

### ログ内容

| 項目 | 説明 |
|------|------|
| 開始時刻 | ジョブ実行開始日時 |
| 実行モード | ローカル/リモート |
| JP1コマンドパス | 使用されるJP1コマンドのパス（ローカルモード時） |
| 保留解除 | `ajsrelease` コマンドの実行結果 |
| ジョブ起動 | `ajsentry` コマンドの実行結果 |
| 状態確認 | `ajsstatus` によるポーリング状況 |
| 完了状態 | 正常終了/異常終了の判定結果 |
| WinRM設定 | TrustedHosts設定・復元状況（リモートモード時） |

### ログ例

```
================================================================================
JP1 ジョブ管理ツール 実行ログ
================================================================================
開始時刻: 2025/12/17 10:30:45
実行モード: リモート
================================================================================

[2025/12/17 10:30:46] ========================================
[2025/12/17 10:30:46] ジョブネット: /main_unit/daily_batch
[2025/12/17 10:30:46] 保留状態: なし
[2025/12/17 10:30:46] ========================================
[2025/12/17 10:30:47] [実行] ajsentry /main_unit/daily_batch
[2025/12/17 10:30:48] [成功] ジョブ起動成功
[2025/12/17 10:30:58] [ポーリング] 状態: running (経過: 10秒)
[2025/12/17 10:31:08] [ポーリング] 状態: normal end (経過: 20秒)
[2025/12/17 10:31:08] [完了] 正常終了
```

**注**: パスワードはログに記録されません（`*****` でマスクされます）。

## シート構成

### メインシート

- 接続設定
- 実行設定
- 操作ボタン

### ジョブ一覧シート

| 列 | 内容 |
|----|------|
| 順序 | 実行順（数字を入力すると実行対象） |
| ジョブネットパス | ジョブネットのフルパス |
| ジョブネット名 | ジョブネット名（ajsprintから取得） |
| コメント | ジョブネットのコメント |
| 保留 | 保留中の場合「保留中」と表示（行もオレンジ色でハイライト） |
| 最終実行結果 | 正常終了/異常終了/起動失敗/保留解除失敗 |
| 開始時刻 | 最終実行の開始時刻 |
| 終了時刻 | 最終実行の終了時刻 |
| 戻り値 | リターンコード |
| 詳細メッセージ | ajsshowで取得した実行詳細 |

### 実行ログシート

実行履歴が記録されます。

## 注意事項

### セキュリティ

- パスワードはExcelに保存しないことを推奨（空欄にして実行時入力）
- マクロ有効ブック（.xlsm）はセキュリティに注意

### 実行権限（リモートモードのみ）

リモートモードでは、WinRM設定の変更に**管理者権限**が必要です。

**自動昇格機能**:
- リモートモードで管理者権限がない場合、自動的に確認ダイアログを表示
- 「はい」を選択すると、ブックを保存後、管理者権限でExcelを再起動
- 「いいえ」を選択すると、そのまま続行（WinRMが既に設定済みの場合に有効）

**注**: ローカルモードでは管理者権限は不要です。

### WinRM設定の自動管理（リモートモードのみ）

リモートモードの場合、WinRM設定を**自動的に管理・復元**します：

- **TrustedHosts**: 実行前に保存し、終了後に元の設定に復元
- **WinRMサービス**: 停止していた場合は起動し、終了後に停止して元の状態に戻す
- **エラー時も復元**: try-finally パターンにより、エラー発生時も確実に復元

**注**: ローカルモードではWinRM設定は変更されません。

### エラー時の動作

- **1つでも失敗したら処理を中断**します
- 失敗したジョブ以降は実行されません
- 実行ログで失敗箇所を確認してください

### JP1環境

- JP1コマンドのパスはデフォルトで以下を探索：
  - `C:\Program Files\HITACHI\JP1AJS3\bin\`
  - `C:\Program Files\Hitachi\JP1AJS2\bin\`
- 異なる場合はVBAコードを修正してください

## トラブルシューティング

### エラー: 「JP1コマンドが見つかりません」（ローカルモード）

→ 以下を確認：
- JP1/AJS3がこのPCにインストールされているか
- インストール先が標準パス（`C:\Program Files\HITACHI\JP1AJS3\bin\`）か

### エラー: 「接続設定が不完全です」（リモートモード）

→ メインシートの必須項目（JP1サーバ、リモートユーザー、JP1ユーザー）を入力してください。

### エラー: 「リモート接続に失敗しました」（リモートモード）

→ 以下を確認：
- JP1サーバでPowerShell Remotingが有効か
- WinRMサービスが起動しているか
- ファイアウォールでポート5985が開放されているか

### ジョブ一覧が取得できない

→ 以下を確認：
- 取得パスが正しいか（`/`で全件）
- JP1ユーザーに参照権限があるか

### 実行しても完了待ちが終わらない

→ タイムアウト設定を確認してください。長時間ジョブの場合は値を大きくするか、0（無制限）に設定。

## ライセンス

MIT License

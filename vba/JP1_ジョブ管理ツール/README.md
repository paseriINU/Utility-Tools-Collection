# JP1 ジョブ管理ツール

Excel VBAでJP1/AJS3のジョブネット一覧を取得し、選択したジョブを順次実行するツールです。

## 概要

- **ジョブ一覧取得**: JP1サーバから`ajsprint`でジョブネット一覧を取得してExcelに表示
- **選択実行**: チェックしたジョブを実行順で順次起動
- **完了待ち**: `ajsstatus`でジョブ完了を監視（正常終了/異常終了を判定）
- **詳細取得**: `ajsshow`で実行結果の詳細を取得
- **エラー停止**: 1つでも失敗したら処理を中断

## 必要な環境

### ローカルPC（実行する側）

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- **管理者権限**（WinRM設定変更に必要）

### JP1サーバ（リモート側）

- Windows Server
- JP1/AJS3 - Manager が稼働中
- PowerShell Remotingが有効（`Enable-PSRemoting`済み）
- WinRMサービスが起動中

## セットアップ

### 1. VBAモジュールのインポート

1. 新規Excelブックを作成
2. `Alt + F11` でVBAエディタを開く
3. 「ファイル」→「ファイルのインポート」
4. 以下の2つのファイルをインポート：
   - `JP1_ジョブ管理ツール_Setup.bas` （初期化モジュール）
   - `JP1_ジョブ管理ツール.bas` （メインモジュール）
5. ブックを `.xlsm` 形式で保存

**ファイル構成**:
```
JP1_ジョブ管理ツール/
├── JP1_ジョブ管理ツール_Setup.bas  # 初期化（シート作成・フォーマット）
├── JP1_ジョブ管理ツール.bas        # メイン処理（ジョブ取得・実行）
└── README.md
```

### 2. 初期化

1. `Alt + F8` でマクロ一覧を表示
2. `InitializeJP1Manager` を実行
3. メインシート、ジョブ一覧シート、実行ログシートが作成される

## 使い方

### 1. 接続設定

メインシートで以下を設定：

| 設定項目 | 説明 | 例 |
|---------|------|---|
| JP1サーバ | JP1サーバのIP/ホスト名 | `192.168.1.100` |
| リモートユーザー | Windowsログインユーザー | `Administrator` |
| リモートパスワード | ※空の場合は実行時に入力 | |
| JP1ユーザー | JP1ユーザー名 | `jp1admin` |
| JP1パスワード | ※空の場合は実行時に入力 | |
| 取得パス | ジョブネット取得の起点 | `/` (全件) |

### 2. ジョブ一覧取得

1. 「**ジョブ一覧取得**」ボタンをクリック
2. パスワード入力（設定が空の場合）
3. ジョブ一覧シートにジョブネットが表示される

### 3. 実行ジョブの選択

ジョブ一覧シートで：

- **順序列**: 実行するジョブに実行順を数字で指定（1, 2, 3...）
- 順序が入力されているジョブのみが実行対象となります

```
| 順序 | ジョブネットパス                    | ジョブネット名    |
|:----:|--------------------------------------|-------------------|
|  1   | /main_unit/jobgroup1/daily_batch    | daily_batch       |
|      | /main_unit/jobgroup1/weekly_batch   | weekly_batch      |
|  2   | /main_unit/jobgroup2/monthly_batch  | monthly_batch     |
```

### 4. ジョブ実行

1. 「**選択ジョブ実行**」ボタンをクリック
2. 確認ダイアログで「はい」を選択
3. 順序に従ってジョブが順次実行される
4. **1つでも失敗したら処理中断**
5. 結果は実行ログシートに記録される

## 実行設定

| 設定項目 | 説明 | デフォルト |
|---------|------|-----------|
| 完了待ち | ジョブ完了を待つか | はい |
| タイムアウト（秒） | 完了待ちの最大時間 | 3600 |
| 状態確認間隔（秒） | ポーリング間隔 | 10 |

## シート構成

### メインシート

- 接続設定
- 実行設定
- 操作ボタン

### ジョブ一覧シート

| 列 | 内容 |
|----|------|
| 順序 | 実行順（数字を入力すると実行対象） |
| ジョブネットパス | ジョブネットのフルパス |
| ジョブネット名 | ジョブネット名（ajsprintから取得） |
| コメント | ジョブネットのコメント |
| 最終実行結果 | 正常終了/異常終了/起動失敗 |
| 開始時刻 | 最終実行の開始時刻 |
| 終了時刻 | 最終実行の終了時刻 |
| 戻り値 | リターンコード |
| 詳細メッセージ | ajsshowで取得した実行詳細 |

### 実行ログシート

実行履歴が記録されます。

## 注意事項

### セキュリティ

- パスワードはExcelに保存しないことを推奨（空欄にして実行時入力）
- マクロ有効ブック（.xlsm）はセキュリティに注意

### 実行権限

- VBAからPowerShellを実行するため、管理者権限が必要な場合があります
- Excelを管理者として実行してください

### エラー時の動作

- **1つでも失敗したら処理を中断**します
- 失敗したジョブ以降は実行されません
- 実行ログで失敗箇所を確認してください

### JP1環境

- JP1コマンドのパスはデフォルトで以下を探索：
  - `C:\Program Files\HITACHI\JP1AJS3\bin\`
  - `C:\Program Files\Hitachi\JP1AJS2\bin\`
- 異なる場合はVBAコードを修正してください

## トラブルシューティング

### エラー: 「接続設定が不完全です」

→ メインシートの必須項目（JP1サーバ、リモートユーザー、JP1ユーザー）を入力してください。

### エラー: 「リモート接続に失敗しました」

→ 以下を確認：
- JP1サーバでPowerShell Remotingが有効か
- WinRMサービスが起動しているか
- ファイアウォールでポート5985が開放されているか

### ジョブ一覧が取得できない

→ 以下を確認：
- 取得パスが正しいか（`/`で全件）
- JP1ユーザーに参照権限があるか

### 実行しても完了待ちが終わらない

→ タイムアウト設定を確認してください。長時間ジョブの場合は値を大きくするか、0（無制限）に設定。

## ライセンス

MIT License

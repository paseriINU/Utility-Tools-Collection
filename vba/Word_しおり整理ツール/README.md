# Word文書しおり整理ツール

## 概要

Word文書の段落テキストをパターンマッチし、指定スタイルを適用するツールです。PDFエクスポート時に正しいしおり（ブックマーク）を生成します。

パターン検出は正規表現を使用し、全角・半角の数字、ハイフン、ピリオド、カンマを自動認識します。

## 機能

- **パターン検出**: 正規表現で「第X部」「第X章」「X-X」「X-X,X」などのパターンを検出
- **スタイル適用**: Excelシートで指定したスタイルを段落に適用
- **図形内テキスト対応**: テキストボックスや図形内のテキストも処理対象
- **連番チェック**: 各レベルで1から始まる連番であることを確認、欠番があれば警告
- **例外処理**: パターン外スタイル、アウトライン設定済み段落を別スタイルに変更
- **全角・半角対応**: 数字、ハイフン、ピリオド、カンマは全角・半角どちらも検出
- **Input/Output方式**: Inputフォルダから処理対象を選択し、Outputフォルダに結果を保存
- **PDF出力**: しおり付きPDFを自動生成

## パターン設定

| レベル | テキストパターン | 正規表現 | 例 |
|--------|-----------------|----------|-----|
| 1 | 第X部 | `第[0-9０-９]+部` | 第1部、第２部 |
| 2 | 第X章 | `第[0-9０-９]+章` | 第1章、第２章 |
| 3 | X-X | `[0-9０-９]+[-－ー][0-9０-９]+(?![,，.．])` | 1-1、２－３ |
| 4 | X-X,X | `[0-9０-９]+[-－ー][0-9０-９]+[,，.．][0-9０-９]+` | 1-1,1、２－３．４ |
| 例外1 | パターン外スタイル | - | パターン外だが既にスタイル適用済み |
| 例外2 | アウトライン設定済み | - | 段落またはスタイルにアウトライン定義あり |

## 必要な環境

- **Microsoft Excel**: 2010以降（マクロ有効ブック `.xlsm` 対応）
- **Microsoft Word**: 2010以降（PDF出力機能が必要）

## インストール/セットアップ

### 1. 新しいExcelマクロ有効ブックを作成

1. Excelを起動
2. 新しいブックを作成
3. 「名前を付けて保存」から「Excelマクロ有効ブック (*.xlsm)」形式で保存
   - 推奨ファイル名: `WordBookmarkOrganizer.xlsm`

### 2. VBAモジュールをインポート

1. Excel上で `Alt + F11` を押してVBAエディタを開く
2. メニューから「ファイル」→「ファイルのインポート」を選択
3. 以下の2つのモジュールを順番にインポート：
   - `WordBookmarkOrganizer_Setup.bas`（初期化・シートフォーマット用）
   - `WordBookmarkOrganizer.bas`（メイン処理用）
4. 標準モジュールが追加されたことを確認

### 3. 初期化の実行

1. VBAエディタで `Alt + F8` を押してマクロ一覧を開く
2. `InitializeWordしおり整理ツール` を選択して「実行」
3. 設定シートとInput/Outputフォルダが自動作成される

### 4. フォルダ構成

マクロファイルと同じフォルダに以下の構成が作成されます：

```
作業フォルダ/
├─ WordBookmarkOrganizer.xlsm  # このExcelマクロファイル
├─ Input/                       # 処理対象のWord文書を配置
│  ├─ sample1.docx
│  └─ sample2.docx
└─ Output/                      # 処理結果が出力される
   ├─ sample1.docx              # スタイル設定済みWord文書
   └─ sample1.pdf               # しおり付きPDF
```

## 使い方

### 基本的な実行方法

1. `WordBookmarkOrganizer.xlsm` を開く
2. 「Word_しおり整理ツール」シートでパターン設定を確認・編集
   - 「適用スタイル」欄にWord文書で使用するスタイル名を入力
3. 処理したいWord文書を `Input` フォルダに配置
4. 「しおりを整理してPDF出力」ボタンをクリック
5. 処理完了まで待機
6. `Output` フォルダで結果を確認

### 設定シートの使い方

| 設定項目 | 説明 |
|----------|------|
| レベル1-4のスタイル | 各パターンに適用するWordスタイル名 |
| 例外1スタイル | パターン外だが既にレベル1-4のスタイルが適用されている段落用 |
| 例外2スタイル | アウトライン設定済みの段落用 |
| 連番チェック | 「はい」で連番チェックを有効化、欠番があれば警告 |
| PDF出力 | 「はい」でPDF出力を有効化 |

### 連番チェックについて

- 各レベルで1から始まる連番であることを確認
- 上位レベルが変わると下位レベルの連番はリセット
  - 例: 第1部→第1章,第2章 / 第2部→第1章(リセット),第2章...
- 欠番があれば処理完了時に警告を表示

## 実行例

### 処理前のWord文書

```
第1部 はじめに
第1章 背景
第2章 目的
1-1 概要
1-2 詳細
1-2,1 サブ項目A
1-2,2 サブ項目B
第2部 システム設計
第1章 アーキテクチャ
```

### 処理結果

- 各段落に指定スタイルが適用される
- 連番が正しければ警告なし
- PDFにしおり（ブックマーク）が生成される

### しおり構造

```
├─ 第1部 はじめに
│  ├─ 第1章 背景
│  ├─ 第2章 目的
│  │  ├─ 1-1 概要
│  │  ├─ 1-2 詳細
│  │  │  ├─ 1-2,1 サブ項目A
│  │  │  └─ 1-2,2 サブ項目B
└─ 第2部 システム設計
   └─ 第1章 アーキテクチャ
```

## 注意事項

### 実行時の注意

- **Wordアプリケーションの自動起動**: このツールはバックグラウンドでWordを起動します
- **元のファイルは保持**: Inputフォルダ内のWord文書は変更されません
- **ファイル上書き**: Outputフォルダに同名のファイルが既に存在する場合、警告なく上書きされます
- **スタイル名**: Word文書に存在しないスタイル名を指定すると警告が出力されます

### パターン検出の動作

- 行のどこにあっても検出（先頭に限らない）
- パターン評価順序: レベル4→3→2→1→例外1→例外2（具体的→抽象的）
- レベル3（X-X）とレベル4（X-X,X）は区別される

### 全角・半角対応

以下の文字は全角・半角どちらも検出されます：

| 種類 | 半角 | 全角 |
|------|------|------|
| 数字 | 0-9 | ０-９ |
| ハイフン | - | － ー |
| カンマ | , | ， |
| ピリオド | . | ． |

## トラブルシューティング

### 1. スタイルが適用されない

**原因**: スタイル名がWord文書に存在しない

**解決方法**:
- Word文書で実際のスタイル名を確認
- 設定シートの「適用スタイル」を正しいスタイル名に修正

### 2. パターンが検出されない

**原因**: テキストが正規表現パターンに一致しない

**解決方法**:
- 数字やハイフンの形式を確認
- イミディエイトウィンドウ（`Ctrl+G`）でデバッグ出力を確認

### 3. 連番チェック警告が出る

**原因**: 連番に欠番がある

**解決方法**:
- Word文書の連番を確認・修正
- または「連番チェック」を「いいえ」に設定

### 4. PDFが出力されない

**原因**: PDF出力が無効化されている、またはWordのバージョン

**解決方法**:
- 「PDF出力」が「はい」になっているか確認
- Word 2010以降がインストールされているか確認

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `WordBookmarkOrganizer_Setup.bas` | 初期化・UIモジュール |
| `WordBookmarkOrganizer.bas` | メインロジックモジュール |
| `README.md` | このファイル |

## 更新履歴

- **2025-12-31**: 図形内テキスト対応を追加
  - テキストボックスや図形内のテキストも処理対象に
- **2025-12-30**: 新仕様で全面リニューアル
  - パターン検出機能を正規表現ベースに変更
  - Excelシートからスタイル名を設定可能に
  - 全角・半角対応を追加
  - 連番チェック機能を追加
  - 例外処理（パターン外スタイル、アウトライン設定済み）を追加
  - 設定リセット機能を追加
- **2025-12-07**: Input/Output方式に変更
- **2025-12-06**: 初版リリース

## 作者

paseriINU

## ライセンス

このツールはMITライセンスの下で公開されています。

---

**関連ツール**: [Utility-Tools-Collection](../../README.md)

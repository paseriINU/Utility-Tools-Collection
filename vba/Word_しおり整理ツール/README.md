# Word文書しおり整理ツール

## 概要

Word文書のセクションヘッダー情報を参照し、本文の該当箇所にスタイルを適用するツールです。PDFエクスポート時に正しいしおり（ブックマーク）を生成します。

## 機能

- **ヘッダー参照方式**: セクションのヘッダーから「第X章」「X-X」「X-X,X」を抽出し、本文で検索
- **パターンマッチ方式**: 「第X部」はヘッダー情報がないため本文から直接検出
- **スタイル適用**: Excelシートで指定したスタイルを段落に適用
- **図形内テキスト対応**: テキストボックスや図形内のテキストも処理対象
- **例外処理**: パターン外スタイル、アウトライン設定済み段落を別スタイルに変更
- **全角・半角対応**: 数字、ハイフン、ピリオド、カンマは全角・半角どちらも検出
- **Input/Output方式**: Inputフォルダから処理対象を選択し、Outputフォルダに結果を保存
- **PDF出力**: しおり付きPDFを自動生成

## 動作の仕組み

### ヘッダー参照方式（レベル2-4）

各セクションのヘッダーからパターンを抽出し、前セクションとの差分を検索対象にします。

| レベル | パターン | 検出方法 |
|--------|----------|----------|
| 2 | 第X章 | ヘッダー参照 |
| 3 | X-X | ヘッダー参照 |
| 4 | X-X,X | ヘッダー参照 |

**動作例:**
```
セクション1のヘッダー: 「第1章　概要」
  → セクション1の本文で「第1章」を検索 → レベル2スタイル適用

セクション2のヘッダー: 「第1章　概要　1-1　詳細」
  → セクション2の本文で「1-1」を検索 → レベル3スタイル適用
  （「第1章」は前セクションにあったので検索しない）

セクション3のヘッダー: 「第1章　概要　1-2　補足」
  → セクション3の本文で「1-2」を検索 → レベル3スタイル適用
```

### パターンマッチ方式（レベル1）

| レベル | パターン | 検出方法 |
|--------|----------|----------|
| 1 | 第X部 | パターンマッチ（本文から直接検出） |

「第X部」はヘッダーに情報がないため、全セクションの本文でパターンマッチにより検出します。

### 例外処理

| 種類 | 説明 |
|------|------|
| 例外1 | パターンに一致しないが、既にレベル1-4のスタイルが適用されている段落 |
| 例外2 | 段落に既にアウトラインレベルが設定されている、またはスタイルにアウトライン定義がある場合 |

## 必要な環境

- **Microsoft Excel**: 2010以降（マクロ有効ブック `.xlsm` 対応）
- **Microsoft Word**: 2010以降（PDF出力機能が必要）

## インストール/セットアップ

### 1. 新しいExcelマクロ有効ブックを作成

1. Excelを起動
2. 新しいブックを作成
3. 「名前を付けて保存」から「Excelマクロ有効ブック (*.xlsm)」形式で保存
   - 推奨ファイル名: `WordBookmarkOrganizer.xlsm`

### 2. VBAモジュールをインポート

1. Excel上で `Alt + F11` を押してVBAエディタを開く
2. メニューから「ファイル」→「ファイルのインポート」を選択
3. 以下の2つのモジュールを順番にインポート：
   - `WordBookmarkOrganizer_Setup.bas`（初期化・シートフォーマット用）
   - `WordBookmarkOrganizer.bas`（メイン処理用）
4. 標準モジュールが追加されたことを確認

### 3. 初期化の実行

1. VBAエディタで `Alt + F8` を押してマクロ一覧を開く
2. `InitializeWordしおり整理ツール` を選択して「実行」
3. 設定シートとInput/Outputフォルダが自動作成される

### 4. フォルダ構成

マクロファイルと同じフォルダに以下の構成が作成されます：

```
作業フォルダ/
├─ WordBookmarkOrganizer.xlsm  # このExcelマクロファイル
├─ Input/                       # 処理対象のWord文書を配置
│  ├─ sample1.docx
│  └─ sample2.docx
└─ Output/                      # 処理結果が出力される
   ├─ sample1.docx              # スタイル設定済みWord文書
   └─ sample1.pdf               # しおり付きPDF
```

## 使い方

### 基本的な実行方法

1. `WordBookmarkOrganizer.xlsm` を開く
2. 「Word_しおり整理ツール」シートでスタイル設定を確認・編集
   - 「適用スタイル」欄にWord文書で使用するスタイル名を入力
3. 処理したいWord文書を `Input` フォルダに配置
4. 「しおりを整理してPDF出力」ボタンをクリック
5. 処理完了まで待機
6. `Output` フォルダで結果を確認

### 設定シートの使い方

| 設定項目 | 説明 |
|----------|------|
| レベル1のスタイル | 「第X部」に適用するWordスタイル名 |
| レベル2のスタイル | 「第X章」に適用するWordスタイル名 |
| レベル3のスタイル | 「X-X」に適用するWordスタイル名 |
| レベル4のスタイル | 「X-X,X」に適用するWordスタイル名 |
| 例外1スタイル | パターン外だが既にレベル1-4のスタイルが適用されている段落用 |
| 例外2スタイル | アウトライン設定済みの段落用 |
| PDF出力 | 「はい」でPDF出力を有効化 |

## 実行例

### 処理前のWord文書（セクション構成）

```
[セクション1] ヘッダーなし
  第1部 はじめに

[セクション2] ヘッダー: 「第1章　背景」
  第1章 背景
  （本文...）

[セクション3] ヘッダー: 「第1章　背景　1-1　概要」
  1-1 概要
  （本文...）

[セクション4] ヘッダー: 「第1章　背景　1-2　詳細」
  1-2 詳細
  （本文...）
```

### 処理結果

- 各段落に指定スタイルが適用される
- PDFにしおり（ブックマーク）が生成される

### しおり構造

```
├─ 第1部 はじめに
│  └─ 第1章 背景
│     ├─ 1-1 概要
│     └─ 1-2 詳細
```

## 注意事項

### 実行時の注意

- **Wordアプリケーションの自動起動**: このツールはバックグラウンドでWordを起動します
- **元のファイルは保持**: Inputフォルダ内のWord文書は変更されません
- **ファイル上書き**: Outputフォルダに同名のファイルが既に存在する場合、警告なく上書きされます
- **スタイル名**: Word文書に存在しないスタイル名を指定すると警告が出力されます

### ヘッダー参照の動作

- 各セクションのプライマリヘッダーからテキストを取得
- ヘッダー内のパターン（第X章、X-X、X-X,X）を正規表現で抽出
- 前セクションのヘッダーと比較し、新しく追加されたパターンのみを検索対象にする
- ヘッダーがない（または空の）セクションでは「第X部」のパターンマッチのみ実行

### 全角・半角対応

以下の文字は全角・半角どちらも検出されます：

| 種類 | 半角 | 全角 |
|------|------|------|
| 数字 | 0-9 | ０-９ |
| ハイフン | - | － ー |
| カンマ | , | ， |
| ピリオド | . | ． |

## トラブルシューティング

### 1. スタイルが適用されない

**原因**: スタイル名がWord文書に存在しない

**解決方法**:
- Word文書で実際のスタイル名を確認
- 設定シートの「適用スタイル」を正しいスタイル名に修正

### 2. ヘッダーからパターンが抽出されない

**原因**: ヘッダーのテキスト形式が想定と異なる

**解決方法**:
- イミディエイトウィンドウ（`Ctrl+G`）でデバッグ出力を確認
- ヘッダーに「第X章」「X-X」「X-X,X」形式のテキストがあるか確認

### 3. 「第X部」が検出されない

**原因**: テキストが正規表現パターンに一致しない

**解決方法**:
- 「第」と「部」の間に数字があるか確認
- 全角・半角が混在していないか確認

### 4. PDFが出力されない

**原因**: PDF出力が無効化されている、またはWordのバージョン

**解決方法**:
- 「PDF出力」が「はい」になっているか確認
- Word 2010以降がインストールされているか確認

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `WordBookmarkOrganizer_Setup.bas` | 初期化・UIモジュール |
| `WordBookmarkOrganizer.bas` | メインロジックモジュール |
| `README.md` | このファイル |

## 更新履歴

- **2025-12-31**: ヘッダー参照方式に変更
  - セクションのヘッダーからパターンを抽出する方式に変更
  - 「第X部」のみパターンマッチ方式を維持
  - 連番チェック機能を削除（ヘッダー参照方式では不要）
- **2025-12-31**: 図形内テキスト対応を追加
- **2025-12-30**: 新仕様で全面リニューアル
- **2025-12-07**: Input/Output方式に変更
- **2025-12-06**: 初版リリース

## 作者

paseriINU

## ライセンス

このツールはMITライセンスの下で公開されています。

---

**関連ツール**: [Utility-Tools-Collection](../../README.md)

# JP1 REST ジョブ管理ツール

JP1/AJS3 Web Console REST APIを使用して、Excelからジョブ階層の表示・ジョブネットの即時実行・ログ取得を行うVBAツールです。

**特徴**: WinRMを使用せず、REST APIのみで動作するため、ネットワーク設定が簡素化されます。

## 機能概要

| 機能 | 説明 |
|------|------|
| ツリー表示 | JP1ジョブ階層をセルベースのツリーで表示 |
| 展開/折りたたみ | ダブルクリックで子ユニットを動的に取得・表示 |
| 即時実行 | 選択したジョブネットを即時実行登録 |
| ログ取得 | 実行結果詳細（標準エラー出力相当）を取得 |
| 完了待ち | 実行完了まで待機して自動でログ取得 |

## 必要な環境

### JP1/AJS3サーバ側
- JP1/AJS3 - Web Console が稼働していること
- REST APIが有効であること（デフォルトポート: HTTP=22252, HTTPS=22253）

### クライアント側
- Microsoft Excel 2010以降
- PowerShell 5.1以降
- JP1/AJS3 Web Consoleへのネットワーク接続

## ファイル構成

```
JP1_REST_ジョブ管理ツール/
├── JP1_REST_Manager_Setup.bas    # 初期化モジュール（シート作成・フォーマット）
├── JP1_REST_Manager.bas          # メイン処理モジュール（API呼び出し・ツリー表示）
└── README.md                     # このファイル
```

## インストール方法

1. 新規Excelブックを作成
2. Alt + F11 でVBAエディタを開く
3. `JP1_REST_Manager_Setup.bas`をインポート
4. `JP1_REST_Manager.bas`をインポート
5. .xlsm形式で保存

## 初期設定

1. VBAエディタで `InitializeJP1RESTManager` マクロを実行
2. 3つのシートが作成されます
   - **設定**: 接続設定
   - **ツリー表示**: ジョブ階層表示
   - **実行ログ**: 操作履歴

## 使い方

### 1. 接続設定

設定シートで以下を入力:

| 項目 | 説明 | 例 |
|------|------|-----|
| Web Consoleサーバ | Web Consoleのホスト名/IP | `jp1server.example.com` |
| Web Consoleポート | REST APIポート | `22252` (HTTP) / `22253` (HTTPS) |
| HTTPS使用 | SSL使用有無 | `いいえ` / `はい` |
| Managerホスト | JP1/AJS3 Managerホスト名 | `jp1server` |
| スケジューラーサービス | サービス名 | `AJSROOT1` |
| JP1ユーザー | 認証ユーザー | `jp1admin` |
| JP1パスワード | パスワード（空なら実行時入力） | - |
| ルートパス | ツリー取得の起点 | `/` または `/グループ名` |
| デバッグモード | 問題調査用モード | `いいえ` / `はい` |

### 2. ツリー取得

1. 「ツリー取得」ボタンをクリック
2. ルートパス配下のユニット一覧が表示されます
3. `>` マークをダブルクリックすると子ユニットを展開
4. `v` マークをダブルクリックすると折りたたみ

### 3. ジョブネット実行

1. 実行したいジョブネットの「選択」列をダブルクリックでチェック
2. 「選択実行」ボタンをクリック
3. 確認ダイアログで「はい」を選択
4. 即時実行が登録されます

**注意**: 実行可能なのはジョブネット（ルートジョブネット/ネストジョブネット）のみです。

### 4. ログ取得

#### 自動取得（完了待ち=はい）
- 実行完了後、自動でログを取得してメモ帳で表示

#### 手動取得
1. execIDがあるユニットの「選択」列をチェック
2. 「ログ取得」ボタンをクリック
3. ログがテキストファイルに保存され、メモ帳で開きます

## 使用するREST API

| API | 用途 |
|-----|------|
| 7.1.1 ユニット一覧取得API | ツリー構造の取得 |
| 7.1.6 即時実行登録API | ジョブネットの即時実行 |
| 7.1.3 実行結果詳細取得API | ログ（標準エラー出力相当）の取得 |

### searchTargetパラメータについて

| パラメータ値 | 説明 | 用途 |
|-------------|------|------|
| `DEFINITION` | 実行中でなくても定義済みユニットを取得 | ツリー表示 |
| `DEFINITION_AND_STATUS` | 実行中のユニットのみ取得 | 即時実行の状態確認 |

## 制限事項

- **最大取得件数**: ユニット一覧は1回のAPI呼び出しで最大1,000件
- **ログサイズ**: 実行結果詳細は最大5MB（超過分は取得不可）
- **実行対象**: ジョブネットのみ（個別ジョブの直接実行は不可）
- **標準出力**: REST APIでは標準出力の取得はできません（標準エラー出力のみ）

## トラブルシューティング

### 接続エラーが発生する

1. **Web Consoleサービス確認**: JP1/AJS3 Web Consoleが起動しているか確認
2. **ポート確認**: ファイアウォールでポート（22252/22253）が開いているか確認
3. **認証情報確認**: JP1ユーザー/パスワードが正しいか確認
4. **権限確認**: JP1ユーザーに必要な権限があるか確認

### ツリーが表示されない（0件で取得完了）

1. **ルートパス確認**: 存在するパスを指定しているか確認
2. **権限確認**: 指定したパスへのアクセス権限があるか確認
3. **初期化マクロ再実行**: デバッグモード設定が追加されていない場合は `InitializeJP1RESTManager` を再実行
4. **デバッグモードで調査**:
   - 設定シートで「デバッグモード」を「はい」に設定
   - 「ツリー取得」を再実行
   - **API応答がMsgBoxで表示されます**（応答内容を確認）
   - VBAエディタの「イミディエイトウィンドウ」(Ctrl+G)でもログを確認
   - Tempフォルダ(`%TEMP%`)に保存されたスクリプト・出力ファイルを確認

### 実行が失敗する

1. **ユニット種別確認**: ジョブネット（ROOTNET/NET）を選択しているか確認
2. **実行登録状態確認**: 対象ジョブネットが既に実行登録されていないか確認
3. **権限確認**: 実行権限があるか確認

## 関連ドキュメント

- [JP1/AJS3 Web Console REST API 仕様](../../JP1_AJS3_REST_API.md)
- [JP1/AJS3 コマンドリファレンス](../../JP1_AJS3_COMMANDS.md)

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025/12/30 | 初版作成 |
| 2025/12/30 | デバッグモード追加、Unicode文字修正 |
| 2025/12/30 | デバッグモード改善（MsgBox表示）、初期値変更（タイムアウト=0、間隔=10秒） |
| 2025/12/30 | 接続エラー表示追加、searchTarget=DEFINITIONに変更、エンコーディング修正 |
| 2025/12/30 | searchTargetパラメータの説明を追加 |

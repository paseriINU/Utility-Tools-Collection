# JP1 ジョブ管理ツール（バッチ版）

Excel VBAでJP1/AJS3のジョブネット一覧を取得し、選択したジョブを順次実行するツールです。
**バッチファイル版**は、ジョブ実行処理を外部バッチファイルに分離しており、設定をバッチファイル内で管理します。

## 概要

- **2つの実行モード**: ローカルモード（このPCのJP1を使用）とリモートモード（WinRM経由）を選択可能
- **ジョブ一覧取得**: `ajsprint`でジョブネット一覧を取得してExcelに表示
- **保留ジョブの可視化**: 保留中のジョブを一覧でハイライト表示（オレンジ色）
- **保留自動解除**: 保留中のジョブを実行する際、`ajsrelease`で自動的に保留解除してから実行
- **選択実行**: チェックしたジョブを実行順で順次起動
- **完了待ち**: `ajsstatus`でジョブ完了を監視（正常終了/異常終了を判定）
- **エラー停止**: 1つでも失敗したら処理を中断
- **実行ログ出力**: 実行履歴をテキストファイルに保存

## 通常版との違い

| 項目 | 通常版 | バッチ版（本ツール） |
|------|--------|---------------------|
| 設定場所 | Excelシート | バッチファイル内 |
| ジョブ実行 | VBA内でPowerShell生成 | 外部バッチファイル呼び出し |
| スタンドアロン実行 | 不可 | 可能（バッチ単体で実行可能） |
| 保守性 | VBA編集が必要 | バッチファイルのみ編集 |

## ファイル構成

```
JP1_ジョブ管理ツール_バッチ版/
├── JP1_ジョブ実行.bat        # ジョブ実行バッチ（★設定はここで編集）
├── JP1_JobManager_Setup.bas  # 初期化モジュール
├── JP1_JobManager.bas        # メインモジュール
└── README.md
```

## 必要な環境

### ローカルモードの場合

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- **JP1/AJS3 - View または Agent**がインストールされていること

### リモートモードの場合

#### ローカルPC（実行する側）

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- **管理者権限**（WinRM設定変更に必要）

#### JP1サーバ（リモート側）

- Windows Server
- JP1/AJS3 - Manager が稼働中
- PowerShell Remotingが有効（`Enable-PSRemoting`済み）
- WinRMサービスが起動中

## セットアップ

### 1. バッチファイルの設定

`JP1_ジョブ実行.bat` をテキストエディタで開き、設定セクションを編集します：

```powershell
#==============================================================================
# ★★★ 設定セクション（ここを編集してください）★★★
#==============================================================================

# 実行モード: "ローカル" または "リモート"
$CONFIG_Mode = "リモート"

# JP1サーバ設定（リモートモード時のみ使用）
$CONFIG_JP1Server = "192.168.1.100"      # JP1サーバのIP/ホスト名
$CONFIG_RemoteUser = "Administrator"      # Windowsログインユーザー
$CONFIG_RemotePassword = ""               # 空の場合は実行時に入力

# JP1認証設定
$CONFIG_JP1User = "jp1admin"              # JP1ユーザー名
$CONFIG_JP1Password = ""                  # 空の場合は実行時に入力

# 実行設定
$CONFIG_Timeout = 0                       # タイムアウト秒（0=無制限）
$CONFIG_PollingInterval = 10              # 状態確認間隔（秒）
```

**パスワードについて**:
- 空欄のままにすると、実行時にセキュアな入力プロンプトが表示されます
- セキュリティを考慮し、パスワードは空欄にすることを推奨します

### 2. VBAモジュールのインポート

1. 新規Excelブックを作成
2. `Alt + F11` でVBAエディタを開く
3. 「ファイル」→「ファイルのインポート」
4. 以下の2つのファイルをインポート：
   - `JP1_JobManager_Setup.bas` （初期化モジュール）
   - `JP1_JobManager.bas` （メインモジュール）
5. ブックを `.xlsm` 形式で保存
6. **重要**: `JP1_ジョブ実行.bat` をExcelブックと同じフォルダに配置

### 3. 初期化

1. `Alt + F8` でマクロ一覧を表示
2. `InitializeJP1Manager` を実行
3. メインシート、ジョブ一覧シート、実行ログシートが作成される

## 使い方

### Excel経由での使用

1. メインシートで「**ジョブ一覧取得**」ボタンをクリック
2. ジョブ一覧シートで実行するジョブの「順序」列に数字を入力（1, 2, 3...）
3. 「**選択ジョブ実行**」ボタンをクリック
4. 確認ダイアログで「はい」を選択
5. 順序に従ってジョブが順次実行される

### バッチファイル単体での使用

コマンドプロンプトから直接実行することも可能です：

```cmd
JP1_ジョブ実行.bat "/main_unit/jobgroup1/daily_batch"
```

**オプション**:
```cmd
JP1_ジョブ実行.bat "ジョブネットパス" [-IsHold true|false] [-NoWait] [-LogFile "ログファイルパス"]
```

| オプション | 説明 | デフォルト |
|-----------|------|-----------|
| `-IsHold true` | 保留中のジョブとして処理（自動解除） | false |
| `-NoWait` | 完了を待たずに終了 | 完了待ち |
| `-LogFile "パス"` | ログ出力先ファイル | なし |

**実行例**:
```cmd
rem 保留中のジョブを解除して実行
JP1_ジョブ実行.bat "/main_unit/daily_batch" -IsHold true

rem 完了を待たずに起動のみ
JP1_ジョブ実行.bat "/main_unit/daily_batch" -NoWait

rem ログファイルに出力
JP1_ジョブ実行.bat "/main_unit/daily_batch" -LogFile "C:\Logs\job.log"
```

## 実行ログファイル

ジョブ実行時の履歴がテキストファイルに自動保存されます。

### 保存場所（Excel経由の場合）

```
[Excelブックのフォルダ]\Logs\JP1_実行ログ_yyyyMMdd_HHmmss.txt
```

### ログ内容

```
================================================================================
JP1 ジョブ管理ツール（バッチ版）実行ログ
================================================================================
開始時刻: 2025/12/17 10:30:45
実行モード: リモート
================================================================================

[2025/12/17 10:30:46] ========================================
[2025/12/17 10:30:46] ジョブネット: /main_unit/daily_batch
[2025/12/17 10:30:46] 保留状態: なし
[2025/12/17 10:30:46] ========================================
[2025/12/17 10:30:47] [実行] ajsentry /main_unit/daily_batch
[2025/12/17 10:30:48] [成功] ジョブ起動成功
[2025/12/17 10:30:58] [ポーリング] 状態: running (経過: 10秒)
[2025/12/17 10:31:08] [ポーリング] 状態: normal end (経過: 20秒)
[2025/12/17 10:31:08] [完了] 正常終了
```

**注**: パスワードはログに記録されません。

## シート構成

### メインシート

- ツールタイトル
- 操作ボタン（ジョブ一覧取得、選択ジョブ実行、一覧クリア）
- 設定確認用の説明文

**注**: バッチ版では設定はバッチファイル内で管理するため、メインシートの設定項目は参照用です。

### ジョブ一覧シート

| 列 | 内容 |
|----|------|
| 順序 | 実行順（数字を入力すると実行対象） |
| ジョブネットパス | ジョブネットのフルパス |
| ジョブネット名 | ジョブネット名 |
| コメント | ジョブネットのコメント |
| 保留 | 保留中の場合「保留中」と表示（行もオレンジ色でハイライト） |
| 最終実行結果 | 正常終了/異常終了/起動失敗/保留解除失敗 |
| 開始時刻 | 最終実行の開始時刻 |
| 終了時刻 | 最終実行の終了時刻 |
| 戻り値 | リターンコード |
| 詳細メッセージ | 実行詳細 |

### 実行ログシート

実行履歴が記録されます。

## 注意事項

### セキュリティ

- パスワードはバッチファイルに直接書かないことを推奨（空欄にして実行時入力）
- バッチファイルにパスワードを記載する場合は、ファイルのアクセス権限に注意

### 実行権限（リモートモードのみ）

リモートモードでは、WinRM設定の変更に**管理者権限**が必要です。

**自動昇格機能**:
- リモートモードで管理者権限がない場合、自動的に確認ダイアログを表示
- 「はい」を選択すると、管理者権限でExcelを再起動

### WinRM設定の自動管理（リモートモードのみ）

リモートモードの場合、WinRM設定を**自動的に管理・復元**します：

- **TrustedHosts**: 実行前に保存し、終了後に元の設定に復元
- **WinRMサービス**: 停止していた場合は起動し、終了後に元の状態に戻す

### エラー時の動作

- **1つでも失敗したら処理を中断**します
- 失敗したジョブ以降は実行されません
- 実行ログで失敗箇所を確認してください

## トラブルシューティング

### エラー: 「JP1コマンドが見つかりません」（ローカルモード）

→ 以下を確認：
- JP1/AJS3がこのPCにインストールされているか
- インストール先が標準パス（`C:\Program Files\HITACHI\JP1AJS3\bin\`）か

### エラー: 「バッチファイルが見つかりません」

→ `JP1_ジョブ実行.bat` がExcelブックと同じフォルダにあるか確認

### エラー: 「リモート接続に失敗しました」（リモートモード）

→ 以下を確認：
- JP1サーバでPowerShell Remotingが有効か
- WinRMサービスが起動しているか
- ファイアウォールでポート5985が開放されているか
- バッチファイル内の接続設定が正しいか

### パスワード入力画面が表示されない

→ バッチファイル内のパスワード設定が空欄であることを確認

## ライセンス

MIT License

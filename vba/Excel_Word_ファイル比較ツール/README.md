# Excel/Word ファイル比較ツール

2つのExcelファイルまたはWordファイルを比較し、差異を一覧表示するVBAマクロです。

## 機能

### `Excel_Word_ファイル比較ツール.bas`

- **CompareExcelFiles**: Excelファイルを比較
  - シート単位・セル単位での差異検出
  - 使用範囲のみを比較（空白セルはスキップ）
  - 差異の種類を識別（値変更、追加、削除、シート追加/削除）
  - 結果を「比較結果」シートに出力
  - 差異セルのハイライト表示（黄色:変更、緑:追加、赤:削除）

- **CompareWordFiles**: Wordファイルを比較（WinMerge方式）
  - **LCS（最長共通部分列）アルゴリズム**を使用
  - 1行追加/削除があっても、以降の行がすべて差異にならない
  - 実際に変更・追加・削除された行のみを正確に検出
  - 旧ファイルと新ファイルの行番号を両方表示
  - スタイル変更も検出（フォント、サイズ、太字/斜体）
  - 結果を「比較結果」シートに出力
  - **差分箇所の検索ジャンプ機能**: 選択した行の差分テキストをWordファイル内で検索し、該当箇所に自動ジャンプ

- **InitializeExcelWordファイル比較ツール**: メインシートを初期化

## 必要な環境

- Microsoft Excel 2010以降
- Microsoft Word 2010以降（Word比較を使用する場合）
- マクロを有効にする必要があります

## インストール方法

### 方法1: .basファイルをインポート（推奨）

1. Excelを開き、`Alt + F11` でVBAエディタを開く
2. 「ファイル」→「ファイルのインポート」を選択
3. 以下の2つのモジュールを順番にインポート：
   - `Excel_Word_ファイル比較ツール_Setup.bas`（初期化・シートフォーマット用）
   - `Excel_Word_ファイル比較ツール.bas`（メイン処理用）
4. `Ctrl + S` で保存（.xlsm形式で保存）

### 方法2: コードをコピー

1. Excelを開き、`Alt + F11` でVBAエディタを開く
2. 「挿入」→「標準モジュール」を2回選択して2つのモジュールを作成
3. 各.basファイルの内容を対応するモジュールにコピー&ペースト
4. `Ctrl + S` で保存（.xlsm形式で保存）

## 使い方

### メインシートの初期化（推奨）

1. マクロを含むExcelファイルを開く
2. `Alt + F8` でマクロダイアログを開く
3. 「InitializeExcelWordファイル比較ツール」を選択して実行
4. メインシートにExcel比較・Word比較ボタンが表示される

### ファイルの比較

1. メインシートの「Excel比較」または「Word比較」ボタンをクリック
2. 1つ目のファイル（旧ファイル）を選択
3. 2つ目のファイル（新ファイル）を選択
4. 比較結果が「比較結果」シートに出力される

## 出力形式

### Excel比較結果シート（比較結果）

| No | シート名 | セル | 差異タイプ | 旧ファイルの値 | 新ファイルの値 | 旧ファイル | 新ファイル |
|----|----------|------|------------|----------------|----------------|------------|------------|
| 1 | Sheet1 | A1 | 変更 | 古い値 | 新しい値 | [移動] | [移動] |
| 2 | Sheet1 | B2 | 追加 | (空) | 追加された値 | [移動] | [移動] |
| 3 | Sheet2 | C3 | 削除 | 削除された値 | (空) | [移動] | [移動] |

### Word比較結果シート（比較結果）- WinMerge方式

| No | 旧行番号 | 新行番号 | 差異タイプ | 旧ファイルのテキスト | 新ファイルのテキスト | 旧スタイル | 新スタイル |
|----|----------|----------|------------|----------------------|----------------------|------------|------------|
| 1 | 5 | 6 | 変更 | 古いテキスト | 新しいテキスト | [標準] ... | [標準] ... |
| 2 | - | 10 | 追加 | | 追加されたテキスト | | [標準] ... |
| 3 | 15 | - | 削除 | 削除されたテキスト | | [標準] ... | |
| 4 | 20 | 21 | スタイル変更 | 同じテキスト | 同じテキスト | [標準] 10pt | [見出し1] 14pt |

**WinMerge方式の利点：**
- 旧行番号と新行番号が分離表示されるため、どの行が対応するか明確
- 追加された行は旧行番号が「-」、削除された行は新行番号が「-」
- 1行追加/削除しても、以降の行が全部ずれて表示されない

**差分箇所の検索ジャンプ機能：**
- 結果シート上部に「旧ファイル検索」「新ファイル検索」ボタンを配置
- 確認したい差異の行を選択し、検索ボタンをクリック
- 該当のWordファイルが開き、差分テキストの位置に自動でジャンプ
- テキストが見つかった場合はその箇所が選択状態で表示

## 色の凡例

- **黄色**: 値の変更
- **緑色**: 新規追加
- **赤色**: 削除
- **薄紫**: スタイル変更（Word比較のみ）

## 設定のカスタマイズ

VBAコード内の以下の定数を編集することで動作を変更できます：

```vba
' 差異ハイライト色
Private Const COLOR_CHANGED As Long = 65535      ' 黄色: 値変更
Private Const COLOR_ADDED As Long = 5296274      ' 緑: 追加
Private Const COLOR_DELETED As Long = 13421823   ' 赤: 削除
```

## 対応ファイル形式

### Excel
- `.xlsx` - Excel ブック
- `.xlsm` - Excel マクロ有効ブック
- `.xls` - Excel 97-2003 ブック
- `.xlsb` - Excel バイナリ ブック

### Word
- `.docx` - Word 文書
- `.docm` - Word マクロ有効文書
- `.doc` - Word 97-2003 文書

## 注意事項

- 大きなファイルの比較には時間がかかる場合があります
- Word比較で5000段落を超える場合は、簡易比較モードに自動切替されます
- セルの数式は評価後の値で比較されます
- Excel比較では書式（色、フォントなど）の違いは検出されません
- 比較中は画面更新が停止しますが、処理完了まで待ってください

## トラブルシューティング

### 「マクロが無効です」と表示される

- Excel/Wordのセキュリティ設定でマクロを有効にしてください
- 「ファイル」→「オプション」→「セキュリティセンター」→「マクロの設定」

### 「Word.Application の作成に失敗しました」

- Microsoft Wordがインストールされていることを確認してください
- Wordが正常に起動できるか確認してください

### Word比較に時間がかかる

- LCSアルゴリズムは段落数の二乗に比例した計算量が必要です
- 5000段落を超える場合は自動的に簡易比較モードに切り替わります
- 簡易比較モードでも実用的な精度で差分を検出できます
- **最適化版（2025-12-17）**: スタイル情報を差分段落のみ取得するように改善し、大幅に高速化

## 更新履歴

- **2025-12-17**: Word比較パフォーマンス最適化
  - スタイル情報の遅延取得（差分が検出された段落のみスタイルを取得）
  - ハッシュによる同一テキストの事前マッチング
  - DoEvents呼び出し頻度の最適化（100→500段落ごと）
  - 大きなファイルでの処理時間を大幅に短縮
- **2025-12-17**: 差分検索ジャンプ機能追加
  - Word比較結果シートに「旧ファイル検索」「新ファイル検索」ボタンを追加
  - 選択した行の差分テキストをWordファイル内で検索し、該当箇所に自動ジャンプ
  - 結果シートの列構成をシンプル化（8列に削減）
- **2025-12-17**: UI改善
  - 結果シート名を「CompareResult」から「比較結果」に変更
- **2025-12-16**: Word比較をWinMerge方式（LCSアルゴリズム）に変更
  - 1行追加/削除があっても以降の行がすべて差異にならない
  - 旧/新行番号を両方表示
- **2025-12-11**: 初版リリース

## ライセンス

MIT License

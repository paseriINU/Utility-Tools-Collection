# PDF しおり検証ツール

PDFのしおり（ブックマーク）がリンク先ページと正しく対応しているかを検証するExcel VBAツールです。

## 概要

- **しおり一覧取得**: PDFからすべてのしおり（階層構造含む）を取得
- **ページ番号確認**: 各しおりのリンク先ページ番号を表示
- **外部DLL不要**: PowerShellの.NET標準機能のみで動作
- **IT制限環境対応**: NuGetやインターネット接続不要
- **判定結果**: OK/確認要の判定を自動で表示
- **CSV出力**: 検証結果をCSVファイルに出力可能

## 必要な環境

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- .NET Framework 4.0以降

**追加インストール不要**: 外部DLLやライブラリのダウンロードは不要です。

## セットアップ

### 1. VBAモジュールのインポート

1. 新規Excelブックを作成
2. `Alt + F11` でVBAエディタを開く
3. 「ファイル」→「ファイルのインポート」
4. 以下の2つのファイルをインポート：
   - `PDFBookmarkValidator_Setup.bas` （初期化モジュール）
   - `PDFBookmarkValidator.bas` （メインモジュール）
5. ブックを `.xlsm` 形式で保存

### 2. 初期化

1. `Alt + F8` でマクロ一覧を表示
2. `InitializePDFBookmarkValidator` を実行
3. 設定シート、検証結果シートが作成される

## 使い方

### 1. PDFファイルの選択

1. 設定シートで「PDFファイル選択」ボタンをクリック
2. 検証したいPDFファイルを選択

### 2. 検証オプションの設定

| 設定項目 | 説明 | デフォルト |
|---------|------|-----------|
| ページ番号確認 | しおりのリンク先ページ番号を取得 | はい |
| テキスト一致確認 | しおり名がページに存在するかチェック | はい |
| 一致判定しきい値 | 一致率がこの値以上でOK判定 | 80% |

### 3. 検証実行

1. 「しおり検証」ボタンをクリック
2. PowerShellウィンドウが開き、解析進捗が表示される
3. 完了後、検証結果シートに結果が表示される

### 4. 結果の確認

検証結果シートで以下を確認：

| 列 | 内容 |
|----|------|
| No | しおり番号 |
| しおり名 | しおりのタイトル |
| 階層 | しおりの階層レベル（1が最上位） |
| リンク先ページ | しおりがリンクしているページ番号 |
| ページ先頭テキスト | リンク先ページの先頭テキスト（100文字） |
| テキスト一致 | 一致/部分一致/不一致 |
| 一致率 | しおり名とページテキストの類似度 |
| 判定 | OK/確認要 |

### 5. CSV出力（オプション）

検証結果シートの「CSV出力」ボタンで結果をCSVファイルに出力できます。

## 判定ロジック

| 判定 | 条件 |
|------|------|
| **OK** | ページ番号が取得できた |
| **確認要** | ページ番号が取得できない（Named destination等） |

## シート構成

### 設定シート

- PDFファイルパス入力
- 検証オプション設定
- 操作ボタン（PDFファイル選択、しおり検証）

### 検証結果シート

- しおり一覧と検証結果
- 色分け表示（OK=緑、確認要=黄）
- CSV出力ボタン

## 技術仕様

### PDF解析方式

このツールはPowerShellの.NET標準機能のみを使用してPDFを直接解析します：

- PDFバイナリを読み込み、正規表現でしおり情報を抽出
- `/Title` タグからしおりタイトルを取得
- `/Dest` タグからリンク先ページ参照を取得
- UTF-16BE（日本語）エンコーディングに対応

### 対応PDFフォーマット

- 標準的なPDF 1.4〜1.7形式
- しおり（Outlines）が設定されているPDF
- 日本語タイトルのしおり

### 制限事項

- **暗号化PDF**: パスワード保護されたPDFは解析できません
- **圧縮しおり**: 一部の高度に圧縮されたPDFでは取得できない場合があります
- **テキスト抽出**: 現在のバージョンではページテキスト抽出は制限付きです

## 注意事項

### PDFの制限

- パスワード保護されたPDFは開けません
- 一部の特殊なPDF形式では正しく解析できない場合があります
- 大きなPDFファイルは処理に時間がかかります

### エンコーディング

- 日本語を含むしおり名も正しく取得できます
- 結果のCSV出力はUTF-8形式です

## トラブルシューティング

### エラー: 「有効なPDFファイルではありません」

→ ファイルがPDF形式であることを確認してください。

### エラー: 「このPDFにはしおりがありません」

→ PDFにしおり（ブックマーク）が設定されていません。Adobe Acrobat等でしおりを追加してください。

### エラー: 「PDFファイルが見つかりません」

→ 以下を確認：
- PDFファイルのパスが正しいか
- PDFファイルが存在するか
- ファイルにアクセス権限があるか

### しおりが取得できない

→ 以下の原因が考えられます：
- PDFが暗号化されている
- しおり情報が特殊な形式で格納されている
- PDFが破損している

## ファイル構成

```
PDF_しおり検証ツール/
├── PDFBookmarkValidator_Setup.bas  # 初期化モジュール
├── PDFBookmarkValidator.bas        # メインモジュール
└── README.md
```

## ライセンス

MIT License

# PDF しおり検証ツール

PDFのしおり（ブックマーク）がリンク先ページと正しく対応しているかを検証するExcel VBAツールです。

## 概要

- **しおり一覧取得**: PDFからすべてのしおり（階層構造含む）を取得
- **ページ番号確認**: 各しおりのリンク先ページ番号を表示
- **テキスト一致確認**: しおり名がリンク先ページに存在するかチェック
- **一致率表示**: しおり名とページテキストの類似度をパーセント表示
- **判定結果**: OK/NG/確認要の判定を自動で表示
- **CSV出力**: 検証結果をCSVファイルに出力可能

## 必要な環境

- Windows OS
- Excel 2010以降（マクロ有効）
- PowerShell 5.1以降
- .NET Framework 4.0以降
- **iTextSharp.dll**（後述のセットアップで配置）

## セットアップ

### 1. VBAモジュールのインポート

1. 新規Excelブックを作成
2. `Alt + F11` でVBAエディタを開く
3. 「ファイル」→「ファイルのインポート」
4. 以下の2つのファイルをインポート：
   - `PDFBookmarkValidator_Setup.bas` （初期化モジュール）
   - `PDFBookmarkValidator.bas` （メインモジュール）
5. ブックを `.xlsm` 形式で保存

### 2. iTextSharp.dll の配置

iTextSharpはPDF解析用の.NETライブラリです。以下の手順で取得・配置してください。

#### 方法1: NuGetから取得（インターネット接続可能な場合）

1. [NuGet Gallery - iTextSharp](https://www.nuget.org/packages/iTextSharp/) にアクセス
2. 「Download package」をクリックして `.nupkg` ファイルをダウンロード
3. ダウンロードしたファイルの拡張子を `.zip` に変更
4. 解凍し、`lib\net40\itextsharp.dll` を取得

#### 方法2: 別PCで取得してコピー（IT制限環境の場合）

1. インターネット接続可能なPCで上記の方法1を実行
2. 取得した `itextsharp.dll` をUSBメモリ等でコピー

#### DLLの配置

1. Excelブックと同じフォルダに `lib` フォルダを作成
2. `itextsharp.dll` を `lib` フォルダに配置

```
[Excelブックのフォルダ]/
├── PDFしおり検証ツール.xlsm
└── lib/
    └── itextsharp.dll
```

### 3. 初期化

1. `Alt + F8` でマクロ一覧を表示
2. `InitializePDFBookmarkValidator` を実行
3. 設定シート、検証結果シートが作成される

## 使い方

### 1. PDFファイルの選択

1. 設定シートで「PDFファイル選択」ボタンをクリック
2. 検証したいPDFファイルを選択

### 2. 検証オプションの設定

| 設定項目 | 説明 | デフォルト |
|---------|------|-----------|
| ページ番号確認 | しおりのリンク先ページ番号を取得 | はい |
| テキスト一致確認 | しおり名がページに存在するかチェック | はい |
| 一致判定しきい値 | 一致率がこの値以上でOK判定 | 80% |

### 3. 検証実行

1. 「しおり検証」ボタンをクリック
2. PowerShellウィンドウが開き、解析進捗が表示される
3. 完了後、検証結果シートに結果が表示される

### 4. 結果の確認

検証結果シートで以下を確認：

| 列 | 内容 |
|----|------|
| No | しおり番号 |
| しおり名 | しおりのタイトル |
| 階層 | しおりの階層レベル（1が最上位） |
| リンク先ページ | しおりがリンクしているページ番号 |
| ページ先頭テキスト | リンク先ページの先頭テキスト（100文字） |
| テキスト一致 | 一致/部分一致/不一致 |
| 一致率 | しおり名とページテキストの類似度 |
| 判定 | OK/NG/確認要 |

### 5. CSV出力（オプション）

検証結果シートの「CSV出力」ボタンで結果をCSVファイルに出力できます。

## 判定ロジック

| 判定 | 条件 |
|------|------|
| **OK** | ページ番号が取得でき、テキスト一致率がしきい値以上 |
| **NG** | テキスト一致率がしきい値未満 |
| **確認要** | ページ番号が取得できない（Named destination等） |

## シート構成

### 設定シート

- PDFファイルパス入力
- 検証オプション設定
- 操作ボタン（PDFファイル選択、しおり検証）

### 検証結果シート

- しおり一覧と検証結果
- 色分け表示（OK=緑、NG=赤、確認要=黄）
- CSV出力ボタン

## 注意事項

### iTextSharpについて

- iTextSharpはAGPLライセンスです
- 商用利用の場合はライセンスを確認してください
- バージョン5.x系を使用してください（iText 7とは互換性なし）

### PDFの制限

- パスワード保護されたPDFは開けません
- 一部の特殊なPDF形式では正しく解析できない場合があります
- 大きなPDFファイルは処理に時間がかかります

### エンコーディング

- 日本語を含むしおり名も正しく取得できます
- 結果のCSV出力はUTF-8形式です

## トラブルシューティング

### エラー: 「iTextSharp.dll が見つかりません」

→ Excelブックと同じフォルダの `lib` サブフォルダに `itextsharp.dll` を配置してください。

### エラー: 「iTextSharp.dll の読み込みに失敗しました」

→ .NET Framework 4.0以降がインストールされているか確認してください。

### エラー: 「PDFファイルを開けませんでした」

→ 以下を確認：
- PDFファイルが存在するか
- PDFがパスワード保護されていないか
- PDFが破損していないか

### エラー: 「このPDFにはしおりがありません」

→ PDFにしおり（ブックマーク）が設定されていません。Adobe Acrobat等でしおりを追加してください。

### テキスト一致率が低い

→ 以下の原因が考えられます：
- しおり名とページ内のテキストが完全に一致していない
- ページがスキャン画像でテキストが抽出できない
- しおり名が省略形で記載されている

## ファイル構成

```
PDF_しおり検証ツール/
├── PDFBookmarkValidator_Setup.bas  # 初期化モジュール
├── PDFBookmarkValidator.bas        # メインモジュール
└── README.md
```

## ライセンス

MIT License

**注意**: このツールはiTextSharp（AGPL）を使用しています。iTextSharpのライセンス条件も確認してください。

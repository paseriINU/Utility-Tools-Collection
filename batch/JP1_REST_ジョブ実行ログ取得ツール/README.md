# JP1 REST API ジョブ実行ログ取得ツール

JP1/AJS3 Web Console REST APIを使用して、ジョブネットを即時実行し、完了後にジョブの実行結果詳細を取得するツールです。

## 概要

以下の5段階の処理で確証性を保証しながら実行します：

1. **STEP 1: 存在確認・種別確認** - `DEFINITION` で指定ユニットの存在とジョブ種別を確認
2. **STEP 2: ルートジョブネット特定** - 定義情報からルートジョブネットを特定
3. **STEP 3: 即時実行登録** - ルートジョブネットを即時実行
4. **STEP 4: 状態監視** - 指定ジョブの完了を待機
5. **STEP 5: 実行結果詳細取得** - execResultDetails APIで実行結果を取得

### 確証性の保証

| チェック項目 | 終了コード | 説明 |
|-------------|-----------|------|
| ユニット存在確認 | 2 | 指定したユニットが存在しない場合 |
| ユニット種別確認 | 3 | 指定したユニットがジョブではない場合 |
| ルートジョブネット特定 | 4 | ルートジョブネットが特定できない場合 |
| 即時実行登録 | 5 | 即時実行登録に失敗した場合 |
| タイムアウト | 6 | 指定時間内に完了しなかった場合 |

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `JP1_REST_ジョブ実行ログ取得ツール.bat` | メインツール（引数必須） |
| `JP1_ジョブ実行ログ取得_サンプル.bat` | 呼び出しサンプル（ファイル保存） |

## 必要な環境

- Windows（PowerShell 5.1以降）
- JP1/AJS3 - Web Console がインストール・起動されていること
- Web Console への接続権限（JP1ユーザー）
- **実行権限**: 対象ジョブネットへの実行登録権限が必要

## 特徴

| 項目 | 説明 |
|------|------|
| 実行方式 | REST API（Web Console経由） |
| 管理者権限 | 不要 |
| WinRM | 不要 |
| 取得情報 | 実行結果詳細（標準出力・標準エラー出力） |
| 出力形式 | Shift-JIS |

## JP1_REST_ジョブ情報取得ツールとの違い

| 項目 | ジョブ情報取得ツール | ジョブ実行ログ取得ツール（本ツール） |
|------|---------------------|-------------------------------------|
| 目的 | 既存の実行結果を取得 | ジョブを実行してから結果を取得 |
| 実行 | 実行しない | 即時実行する |
| 世代 | 直近終了世代（RESULT） | 今回実行した世代 |
| 用途 | 過去のログ確認 | テスト実行・動作確認 |

## 使い方

### メインツール

引数にユニットパスを指定して実行します：

```batch
JP1_REST_ジョブ実行ログ取得ツール.bat "/JobGroup/Jobnet/Job1"
```

**注意**:
- 引数なしでは実行できません（エラーになります）
- **ルートジョブネット全体が即時実行されます**

### サンプルバッチ

1. `JP1_ジョブ実行ログ取得_サンプル.bat` を編集：

```batch
rem === ここを編集してください ===
set "UNIT_PATH=/JobGroup/Jobnet/Job1"

rem === スクロール位置の設定 ===
rem メモ帳で開いた後、指定した文字列を検索してその位置にスクロールします
rem 例: "エラー", "ERROR", "RC=", "異常終了" など
set "SCROLL_TO_TEXT=エラー"
```

2. ダブルクリックで実行
3. 実行確認のプロンプトで `y` を入力
4. ジョブが実行され、完了を待機
5. 結果が `【ジョブ実行結果】【{日時}実行分】{ジョブネット名}_{コメント}.txt` 形式で保存されます
   - 例: `【ジョブ実行結果】【20251010_163520実行分】Jobnet_テスト.txt`

### 他バッチからの呼び出し

```batch
@echo off
setlocal

rem JP1_REST_ジョブ実行ログ取得ツールを呼び出し
call "C:\path\to\JP1_REST_ジョブ実行ログ取得ツール.bat" "/JobGroup/Jobnet/Job1" > result.txt 2>&1

rem 結果を処理
type result.txt
```

## 設定項目

メインツール内の設定セクションを編集してください：

### 接続設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$webConsoleHost` | Web Consoleサーバーのホスト名 | `localhost` |
| `$webConsolePort` | Web Consoleのポート番号 | `22252` |
| `$useHttps` | HTTPS使用フラグ | `$false` |
| `$managerHost` | JP1/AJS3 Managerのホスト名 | `localhost` |
| `$schedulerService` | スケジューラーサービス名 | `AJSROOT1` |
| `$jp1User` | JP1ユーザー名（空欄で資格情報マネージャー使用） | `""`（空欄） |
| `$jp1Password` | JP1パスワード（空欄で資格情報マネージャー使用） | `""`（空欄） |
| `$credentialTarget` | 資格情報マネージャーのターゲット名 | `JP1_WebConsole` |

### 認証方法（優先順位）

1. **スクリプト内に直接記載** → そのまま使用
2. **空欄** → Windows資格情報マネージャーから取得
3. **資格情報なし** → 実行時に入力プロンプト表示

### Windows資格情報マネージャーの登録方法

コマンドプロンプトで以下を実行：
```batch
cmdkey /generic:JP1_WebConsole /user:jp1admin /pass:yourpassword
```

または「資格情報マネージャー」（コントロールパネル）からGUIで登録できます。

### 実行設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$timeoutSeconds` | ジョブ完了待ちのタイムアウト（秒） | `3600`（60分） |
| `$pollIntervalSeconds` | ステータス確認間隔（秒） | `5` |

### サンプルバッチの設定項目

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `UNIT_PATH` | 実行対象のジョブパス | `/JobGroup/Jobnet/Job1` |
| `SCROLL_TO_TEXT` | メモ帳で開いた後に検索・スクロールする文字列 | （空欄=スクロールなし） |
| `DEFAULT_COMMENT` | ジョブネットコメントが空の場合のデフォルト値 | `NoComment` |

## 使用API

| API | 用途 | STEP |
|-----|------|------|
| ユニット一覧取得API (7.1.1) | 存在確認（DEFINITION） | STEP 1 |
| 即時実行登録API (7.1.6) | ルートジョブネットを即時実行 | STEP 3 |
| ユニット一覧取得API (7.1.1) | 状態監視（DEFINITION_AND_STATUS） | STEP 4 |
| 実行結果詳細取得API (7.1.3) | 実行結果詳細取得 | STEP 5 |

詳細は [JP1_AJS3_REST_API.md](../../JP1_AJS3_REST_API.md) を参照してください。

## 終了コード（実行順）

| コード | STEP | 説明 |
|--------|------|------|
| 0 | - | 正常終了 |
| 1 | - | 引数エラー（ユニットパスが指定されていない、またはパス形式が不正） |
| 2 | STEP 1 | ユニット未検出（指定したユニットが存在しません） |
| 3 | STEP 1 | ユニット種別エラー（指定したユニットがジョブではありません） |
| 4 | STEP 2 | ルートジョブネット特定エラー |
| 5 | STEP 3 | 即時実行登録エラー |
| 6 | STEP 4 | タイムアウト（指定時間内に完了しませんでした） |
| 7 | STEP 5 | 5MB超過エラー（実行結果が切り捨てられました） |
| 8 | STEP 5 | 詳細取得エラー（実行結果詳細の取得に失敗） |
| 9 | 全STEP | API接続エラー（各STEPでの接続失敗） |
| 10 | サンプル | ジョブ開始日時取得エラー（START_TIMEが空） |

## 出力形式

### メインツール（標準出力）

- **文字コード**: Shift-JIS
- **形式**:
  - 1行目: `START_TIME:yyyyMMdd_HHmmss`（ジョブ開始日時）
  - 2行目: `JOBNET_NAME:ジョブネット名`（親ジョブネット名）
  - 3行目: `JOBNET_COMMENT:コメント`（親ジョブネットのコメント）
  - 4行目: `JOB_STATUS:ステータス`（ジョブ終了ステータス）
  - 5行目以降: 実行結果詳細のテキスト出力
- **エラー時**: 終了コードで判定

### 出力例（メインツール）

```
START_TIME:20250105_153028
JOBNET_NAME:Jobnet
JOBNET_COMMENT:テスト
JOB_STATUS:NORMAL
（実行結果詳細の内容）
```

### サンプルバッチ（ファイル保存）

- **文字コード**: Shift-JIS
- **ファイル名形式**: `【ジョブ実行結果】【yyyyMMdd_HHmmss実行分】ジョブネット名_コメント.txt`
  - 例: `【ジョブ実行結果】【20250106_143028実行分】Jobnet_テスト.txt`
- **出力先**: サンプルバッチと同じディレクトリ

## 注意事項

- **即時実行**: ルートジョブネット全体が即時実行されます
- **実行権限**: JP1ユーザーに実行登録権限（JP1_AJS_Operator以上）が必要です
- **重複実行**: ジョブネットが既に実行中の場合はエラーになることがあります
- JP1/AJS3 - Web Console が必要です
- パスワードはスクリプト内に平文で記載されます（セキュリティに注意）
- メインツールは単体では実行できません（引数必須）

## 関連ツール

| ツール | 説明 |
|--------|------|
| [JP1 REST ジョブ情報取得ツール](../JP1_REST_ジョブ情報取得ツール/) | 既存の実行結果を取得（実行せずに取得） |
| [JP1 ジョブツール](../JP1_ジョブツール/) | ajsshowコマンドでジョブ情報取得（WinRM経由） |
| [JP1 ジョブログ取得ツール](../JP1_ジョブログ取得ツール/) | jpqjobgetコマンドでスプール取得 |

## トラブルシューティング

### 接続できない

- Web Consoleサービスが起動しているか確認してください
- ファイアウォールでポートがブロックされていないか確認してください
- ホスト名・ポート番号が正しいか確認してください

### 認証エラー

- JP1ユーザー名・パスワードが正しいか確認してください
- JP1ユーザーに実行権限があるか確認してください

### ユニットが取得できない

- ユニットパスが正しいか確認してください（`/`から始まるフルパス）
- ジョブのパスを指定してください（ジョブネットではなくジョブ）

### 即時実行登録エラー

- ジョブネットが既に実行中でないか確認してください
- JP1ユーザーに実行登録権限があるか確認してください
- ジョブネットが実行登録可能な状態か確認してください

### タイムアウト

- `$timeoutSeconds` の値を増やしてください
- ジョブの実行時間を確認してください
- ジョブが正常に開始されているか確認してください

### 結果が空

- 指定したジョブが正常に実行されたか確認してください
- ジョブが出力を生成しているか確認してください

## ライセンス

MIT License

# SSH_公開鍵配置ツール

## 概要

SSH公開鍵を生成し、Linuxサーバーに自動配置するWindowsバッチスクリプトです。

PowerShell polyglot pattern を使用し、Windows OpenSSH Client で鍵の生成から配置、接続テストまでを一括で実行します。

### 主な機能

- **SSH鍵ペアの自動生成**: Ed25519（推奨）またはRSA鍵を生成
- **公開鍵の自動配置**: Linuxサーバーの`authorized_keys`に追記
- **重複チェック**: 既に登録済みの鍵はスキップ
- **接続テスト**: 公開鍵認証での接続を自動確認
- **コメント自動付与**: `ユーザー名@コンピューター名` を鍵に付与

## 必要な環境

### 必須

- **Windows 10 (1809以降) / Windows 11**
- **Windows OpenSSH Client**: 標準搭載（オプション機能で有効化）
- **Linuxサーバー**: パスワード認証が有効であること（初回接続時に必要）

### OpenSSH Clientの確認方法

```cmd
ssh -V
ssh-keygen --help
```

### OpenSSH Clientのインストール方法

1. **設定** > **アプリ** > **オプション機能**
2. **機能の追加** をクリック
3. **OpenSSH クライアント** を検索してインストール

## インストール/セットアップ

### 1. バッチファイルの設定

`SSH_公開鍵配置ツール.bat` をテキストエディタで開き、設定セクションを編集：

```powershell
#region 設定 - ここを編集してください
#==============================================================================

# Linuxサーバー接続情報
$SSH_HOST = "linux-server"      # ホスト名またはIPアドレス
$SSH_USER = "youruser"          # SSHユーザー名
$SSH_PORT = 22                  # SSHポート番号

# 鍵ファイル設定
$KEY_NAME = "id_ed25519"        # 鍵ファイル名
$KEY_TYPE = "ed25519"           # 鍵の種類: "ed25519" または "rsa"
$KEY_BITS = 4096                # RSAの場合のビット数
$USE_PASSPHRASE = $false        # パスフレーズの使用

#==============================================================================
#endregion
```

### 2. 実行

バッチファイルをダブルクリックまたはコマンドプロンプトから実行：

```cmd
SSH_公開鍵配置ツール.bat
```

## 使い方

### 実行の流れ

1. **設定確認**
   ```
   ================================================================
   設定内容
   ================================================================

     接続先: youruser@linux-server:22
     鍵の種類: ed25519
     鍵ファイル名: id_ed25519
     鍵のコメント: tanaka@WORK-PC
     パスフレーズ: なし
     配置方法: authorized_keys に追記（重複チェックあり）

   この設定で実行しますか？ (y/n):
   ```

2. **鍵ペアの生成**
   ```
   ================================================================
     SSH鍵ペアの生成
   ================================================================

   [実行] 鍵ペアを生成中...

   [成功] 鍵ペアを生成しました
     秘密鍵: C:\Users\tanaka\.ssh\id_ed25519
     公開鍵: C:\Users\tanaka\.ssh\id_ed25519.pub
     コメント: tanaka@WORK-PC
   ```

3. **公開鍵の配置**（パスワード入力が必要）
   ```
   ================================================================
     公開鍵のLinuxサーバーへの配置
   ================================================================

   パスワード認証でLinuxサーバーに接続し、公開鍵を配置します。
   パスワードの入力を求められたら、Linuxサーバーのパスワードを入力してください。

   youruser@linux-server's password: ********
   [OK] 公開鍵を追記しました

   [成功] 公開鍵の配置が完了しました
   ```

4. **接続テスト**
   ```
   ================================================================
     SSH接続テスト（公開鍵認証）
   ================================================================

   [実行] 公開鍵認証で接続テスト中...

   [OK] SSH公開鍵認証で接続成功！

   ================================================================
     SSH公開鍵認証の設定が完了しました！
   ================================================================

   以下のコマンドでパスワードなしで接続できます:

     ssh -i "C:\Users\tanaka\.ssh\id_ed25519" youruser@linux-server

   他のツールで使用する場合の設定値:

     $SSH_KEY = "C:\Users\tanaka\.ssh\id_ed25519"
     $SSH_USER = "youruser"
     $SSH_HOST = "linux-server"
     $SSH_PORT = 22
   ```

## 設定項目の説明

### Linuxサーバー接続情報

| 項目 | 説明 | 例 |
|-----|------|-----|
| `$SSH_HOST` | 接続先のホスト名またはIPアドレス | `192.168.1.100` |
| `$SSH_USER` | SSHログインユーザー名 | `deploy` |
| `$SSH_PORT` | SSHポート番号 | `22` |

### 鍵ファイル設定

| 項目 | 説明 | デフォルト |
|-----|------|----------|
| `$KEY_NAME` | 鍵ファイル名 | `id_ed25519` |
| `$KEY_TYPE` | 鍵の種類 | `ed25519` |
| `$KEY_BITS` | RSA鍵のビット数 | `4096` |
| `$USE_PASSPHRASE` | パスフレーズの使用 | `$false` |

### 鍵の種類

| 種類 | 特徴 | 推奨用途 |
|-----|------|---------|
| `ed25519` | 高速・高セキュリティ・短い鍵長 | 新規環境（推奨） |
| `rsa` | 互換性が高い | 古い環境との互換性が必要な場合 |

### パスフレーズ

| 設定 | 説明 |
|-----|------|
| `$false` | パスフレーズなし（自動化に適している） |
| `$true` | パスフレーズあり（毎回入力が必要） |

## 注意事項

### セキュリティ

- **秘密鍵の管理**: 秘密鍵（`id_ed25519`）は絶対に他人に渡さないでください
- **パスフレーズ**: セキュリティを重視する場合は `$USE_PASSPHRASE = $true` に設定
- **権限**: Linuxサーバー側で `~/.ssh` は 700、`authorized_keys` は 600 である必要があります

### 初回接続

- 初回接続時はLinuxサーバーのパスワードが必要です
- 公開鍵配置後は、パスワードなしで接続できます

### 既存の鍵

- 既に同名の鍵ファイルが存在する場合、上書きするか確認されます
- 既存の鍵を使用する場合は「n」を選択してください

## トラブルシューティング

### OpenSSH Clientがインストールされていない

```
[エラー] Windows OpenSSH Clientがインストールされていません
```

**解決方法**:
1. 設定 > アプリ > オプション機能 > OpenSSH クライアント をインストール

### パスワード認証に失敗する

```
[エラー] 公開鍵の配置に失敗しました
```

**解決方法**:
1. ユーザー名・ホスト名・ポートが正しいか確認
2. Linuxサーバーでパスワード認証が有効か確認
   ```bash
   # /etc/ssh/sshd_config で以下を確認
   PasswordAuthentication yes
   ```

### 公開鍵認証での接続に失敗する

```
[警告] 公開鍵認証での接続に失敗しました
```

**解決方法**:
1. Linuxサーバーの設定を確認
   ```bash
   # /etc/ssh/sshd_config で以下を確認
   PubkeyAuthentication yes
   ```
2. パーミッションを確認
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
3. SELinuxが有効な場合
   ```bash
   restorecon -Rv ~/.ssh
   ```

## 他のツールとの連携

このツールで生成した鍵は、以下のツールで使用できます：

- **Git_Linuxデプロイツール**: `$SSH_KEY` に秘密鍵のパスを設定
- **リモートバッチ実行ツール**: SSH接続設定に使用

## ライセンス

MIT License

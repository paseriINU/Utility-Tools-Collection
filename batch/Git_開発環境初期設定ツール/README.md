# Git 開発環境初期設定ツール

## 概要

Git開発環境のセットアップを一括で行うWindowsバッチスクリプトです。

PowerShell polyglot pattern を使用し、Windows OpenSSH Client で鍵の生成から配置、接続テスト、リポジトリクローンまでを一括で実行します。

### 主な機能

- **Git globalの自動設定**: user.name / user.email を未設定の場合に自動設定
- **SSH鍵ペアの自動生成**: Ed25519（推奨）またはRSA鍵を生成
- **公開鍵の自動配置**: Linuxサーバーの`authorized_keys`に追記
- **重複チェック**: 既に登録済みの鍵はスキップ
- **接続テスト**: 公開鍵認証での接続を自動確認
- **コメント自動付与**: `ユーザー名@コンピューター名` を鍵に付与
- **Gitリポジトリのクローン**: 設定されている場合、リポジトリを自動クローン
- **WinMergeフィルター設定**: .gitignore等のGit管理ファイルを比較から除外

## 必要な環境

### 必須

- **Windows 10 (1809以降) / Windows 11**
- **Windows OpenSSH Client**: 標準搭載（オプション機能で有効化）
- **Linuxサーバー**: パスワード認証が有効であること（初回接続時に必要）

### オプション

- **Git for Windows**: リポジトリクローン機能を使用する場合
- **WinMerge**: フィルター設定機能を使用する場合

### OpenSSH Clientの確認方法

```cmd
ssh -V
ssh-keygen --help
```

### OpenSSH Clientのインストール方法

1. **設定** > **アプリ** > **オプション機能**
2. **機能の追加** をクリック
3. **OpenSSH クライアント** を検索してインストール

## インストール/セットアップ

### 1. バッチファイルの設定

`Git_開発環境初期設定ツール.bat` をテキストエディタで開き、設定セクションを編集：

```powershell
#region 設定 - ここを編集してください
#==============================================================================

# Linuxサーバー接続情報
$SSH_HOST = "linux-server"      # ホスト名またはIPアドレス
$SSH_USER = "youruser"          # SSHユーザー名
$SSH_PORT = 22                  # SSHポート番号
$SSH_PASSWORD = ""              # SSHパスワード（空欄の場合は実行時に入力）

# 鍵ファイル設定
$KEY_NAME = "id_ed25519"        # 鍵ファイル名
$KEY_TYPE = "ed25519"           # 鍵の種類: "ed25519" または "rsa"
$KEY_BITS = 4096                # RSAの場合のビット数
$USE_PASSPHRASE = $false        # パスフレーズの使用

# Gitリポジトリクローン設定（空欄の場合はスキップ）
$GIT_CLONE_URL = ""             # クローンするリポジトリのURL
$GIT_LOCAL_PATH = ""            # クローン先のローカルパス

# WinMergeフィルター設定
$SETUP_WINMERGE_FILTER = $true  # WinMergeフィルターを設定するか
$WINMERGE_EXCLUDE_FILES = @(    # 比較時に除外するファイル名パターン
    ".gitignore",
    ".gitkeep",
    ".gitattributes"
)

#==============================================================================
#endregion
```

### 2. 実行

バッチファイルをダブルクリックまたはコマンドプロンプトから実行：

```cmd
Git_開発環境初期設定ツール.bat
```

## 使い方

### 実行の流れ

1. **Git設定の確認・自動設定**
   ```
   ================================================================
     Git設定の確認
   ================================================================

   [OK] Git が利用可能です

     user.name: tanaka (設定済み)
     user.email: tanaka@example.com (自動設定しました)
   ```

2. **設定確認**
   ```
   ================================================================
   設定内容
   ================================================================

     接続先: youruser@linux-server:22
     鍵の種類: ed25519
     鍵ファイル名: id_ed25519
     鍵のコメント: tanaka@WORK-PC
     パスフレーズ: なし
     配置方法: authorized_keys に追記（重複チェックあり）

   この設定で実行しますか？ (y/n):
   ```

3. **鍵ペアの生成**
   ```
   ================================================================
     SSH鍵ペアの生成
   ================================================================

   [実行] 鍵ペアを生成中...

   [成功] 鍵ペアを生成しました
     秘密鍵: C:\Users\tanaka\.ssh\id_ed25519
     公開鍵: C:\Users\tanaka\.ssh\id_ed25519.pub
     コメント: tanaka@WORK-PC
   ```

4. **公開鍵の配置**（パスワード入力が必要）
   ```
   ================================================================
     公開鍵のLinuxサーバーへの配置
   ================================================================

   パスワード認証でLinuxサーバーに接続し、公開鍵を配置します。
   パスワードの入力を求められたら、Linuxサーバーのパスワードを入力してください。

   youruser@linux-server's password: ********
   [OK] 公開鍵を追記しました

   [成功] 公開鍵の配置が完了しました
   ```

5. **接続テスト**
   ```
   ================================================================
     SSH接続テスト（公開鍵認証）
   ================================================================

   [実行] 公開鍵認証で接続テスト中...

   [OK] SSH公開鍵認証で接続成功！
   ```

6. **Gitリポジトリのクローン**（設定されている場合）
   ```
   ================================================================
     Gitリポジトリのクローン
   ================================================================

   [実行] リポジトリをクローン中...
   Cloning into 'C:\Projects\MyRepo'...

   [成功] リポジトリのクローンが完了しました
   ```

7. **WinMergeフィルター設定**（WinMergeがインストールされている場合）
   ```
   ================================================================
     WinMergeフィルター設定
   ================================================================

   [OK] WinMergeが見つかりました: C:\Program Files\WinMerge\WinMergeU.exe

   [作成] フィルターファイルを作成しました

   [設定] WinMergeのフィルター設定を更新中...
   [成功] フィルターを自動有効化しました
     レジストリ: HKCU:\Software\Thingamahoochie\WinMerge\Settings
     FileFilterPath: C:\Users\tanaka\AppData\Roaming\WinMerge\Filters\GitFiles.flt
     ApplyFolderFilters: 1 (有効)

     フィルターファイル: C:\Users\tanaka\AppData\Roaming\WinMerge\Filters\GitFiles.flt

   除外対象ファイル:
     - .gitignore
     - .gitkeep
     - .gitattributes

   [完了] フィルターは自動的に有効化されました
     次回WinMergeを起動すると、フォルダ比較時にフィルターが適用されます
   ```

8. **完了**
   ```
   ================================================================
     Git開発環境の初期設定が完了しました！
   ================================================================

   以下のコマンドでパスワードなしで接続できます:

     ssh -i "C:\Users\tanaka\.ssh\id_ed25519" youruser@linux-server

   他のツールで使用する場合の設定値:

     $SSH_KEY = "C:\Users\tanaka\.ssh\id_ed25519"
     $SSH_USER = "youruser"
     $SSH_HOST = "linux-server"
     $SSH_PORT = 22
   ```

## 設定項目の説明

### Linuxサーバー接続情報

| 項目 | 説明 | 例 |
|-----|------|-----|
| `$SSH_HOST` | 接続先のホスト名またはIPアドレス | `192.168.1.100` |
| `$SSH_USER` | SSHログインユーザー名 | `deploy` |
| `$SSH_PORT` | SSHポート番号 | `22` |
| `$SSH_PASSWORD` | SSHパスワード（空欄で実行時入力） | - |

### 鍵ファイル設定

| 項目 | 説明 | デフォルト |
|-----|------|----------|
| `$KEY_NAME` | 鍵ファイル名 | `id_ed25519` |
| `$KEY_TYPE` | 鍵の種類 | `ed25519` |
| `$KEY_BITS` | RSA鍵のビット数 | `4096` |
| `$USE_PASSPHRASE` | パスフレーズの使用 | `$false` |

### Gitリポジトリクローン設定

| 項目 | 説明 | 例 |
|-----|------|-----|
| `$GIT_CLONE_URL` | クローンするリポジトリURL | `git@github.com:user/repo.git` |
| `$GIT_LOCAL_PATH` | クローン先のローカルパス | `C:\Projects\MyRepo` |

### WinMergeフィルター設定

| 項目 | 説明 | デフォルト |
|-----|------|----------|
| `$SETUP_WINMERGE_FILTER` | WinMergeフィルターを設定するか | `$true` |
| `$WINMERGE_EXCLUDE_FILES` | 比較時に除外するファイル名 | `.gitignore`, `.gitkeep`, `.gitattributes` |

### 鍵の種類

| 種類 | 特徴 | 推奨用途 |
|-----|------|---------|
| `ed25519` | 高速・高セキュリティ・短い鍵長 | 新規環境（推奨） |
| `rsa` | 互換性が高い | 古い環境との互換性が必要な場合 |

### パスフレーズ

| 設定 | 説明 |
|-----|------|
| `$false` | パスフレーズなし（自動化に適している） |
| `$true` | パスフレーズあり（毎回入力が必要） |

## 注意事項

### セキュリティ

- **秘密鍵の管理**: 秘密鍵（`id_ed25519`）は絶対に他人に渡さないでください
- **パスフレーズ**: セキュリティを重視する場合は `$USE_PASSPHRASE = $true` に設定
- **権限**: Linuxサーバー側で `~/.ssh` は 700、`authorized_keys` は 600 である必要があります

### 初回接続

- 初回接続時はLinuxサーバーのパスワードが必要です
- 公開鍵配置後は、パスワードなしで接続できます

### 既存の鍵

- 既に同名の鍵ファイルが存在する場合、上書きするか確認されます
- 既存の鍵を使用する場合は「n」を選択してください

## トラブルシューティング

### OpenSSH Clientがインストールされていない

```
[エラー] Windows OpenSSH Clientがインストールされていません
```

**解決方法**:
1. 設定 > アプリ > オプション機能 > OpenSSH クライアント をインストール

### Gitがインストールされていない

```
[警告] Gitがインストールされていません
```

**解決方法**:
1. [Git for Windows](https://git-scm.com/download/win) をインストール
2. リポジトリクローン機能が不要な場合はそのまま続行可能

### パスワード認証に失敗する

```
[エラー] 公開鍵の配置に失敗しました
```

**解決方法**:
1. ユーザー名・ホスト名・ポートが正しいか確認
2. Linuxサーバーでパスワード認証が有効か確認
   ```bash
   # /etc/ssh/sshd_config で以下を確認
   PasswordAuthentication yes
   ```

### 公開鍵認証での接続に失敗する

```
[警告] 公開鍵認証での接続に失敗しました
```

**解決方法**:
1. Linuxサーバーの設定を確認
   ```bash
   # /etc/ssh/sshd_config で以下を確認
   PubkeyAuthentication yes
   ```
2. パーミッションを確認
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/authorized_keys
   ```
3. SELinuxが有効な場合
   ```bash
   restorecon -Rv ~/.ssh
   ```

## 他のツールとの連携

このツールで生成した鍵は、以下のツールで使用できます：

- **Git_Linuxデプロイツール**: `$SSH_KEY` に秘密鍵のパスを設定
- **リモートバッチ実行ツール**: SSH接続設定に使用

## ライセンス

MIT License

# TFS_to_Git_同期ツール

TFS（Team Foundation Server）のローカルディレクトリとGitリポジトリを同期するWindowsバッチスクリプトです。

## 機能

- ✅ **TFS最新取得**: 比較前にTFSワークスペースを自動更新（`tf get`）
- ✅ **高速な差分チェック**: PowerShellとMD5ハッシュで大量のファイルを効率的に処理
- ✅ **自動同期**: TFS→Gitへファイル更新・新規追加・削除を自動実行
- ✅ **空フォルダ対応**: TFSの空フォルダもGitに同期（.gitignore自動作成）
- ✅ **双方向差分検出**: TFSのみ・Gitのみのファイル/フォルダを正確に検出
- ✅ **Gitブランチ管理**: 実行前にブランチ確認・切り替えが可能
- ✅ **日本語対応**: UTF-8モードで日本語のブランチ名・ファイル名に対応
- ✅ **コミット機能**: 同期後にオプションでGitコミット可能
- ✅ **ポリグロット形式**: .bat形式でPowerShellロジックを内包し、1ファイルで完結

## 動作の流れ

1. **TFS最新取得**: `tf get /recursive` でTFSワークスペースを最新に更新
2. TFSとGitのディレクトリ内のファイル・フォルダを再帰的にスキャン
3. MD5ハッシュでファイルの差分をチェック
4. 以下の処理を実行:
   - **ファイル更新**: TFSとGitで内容が異なるファイルをコピー
   - **ファイル新規追加**: TFSにのみ存在するファイルをコピー
   - **ファイル削除**: Gitにのみ存在するファイルを削除
   - **フォルダ新規作成**: TFSにのみ存在する空フォルダを作成（.gitignore付き）
   - **フォルダ削除**: Gitにのみ存在するフォルダを削除
5. 処理結果を統計表示
6. オプションでGitコミット

## ファイル構成

```
TFS_to_Git_同期ツール/
├── TFS_to_Git_同期ツール.bat  # TFS-Git同期ツール（ポリグロット版）
└── README.md                  # このファイル
```

**注**: このツールはポリグロット形式で、.batファイル内にPowerShellロジックが含まれています。1ファイルで完結します。

## 必要な環境

- Windows 10/11
- PowerShell 5.1以降（Windows標準で搭載）
- Git for Windows
  - **自動チェック**: スクリプト実行時にGitのインストールを自動確認します
  - Gitが未インストールの場合は、インストールガイドを表示します
- TFS（Team Foundation Server）クライアント（オプション）
  - `tf` コマンドが利用可能な場合、比較前にTFSワークスペースを自動更新
  - Visual Studio開発者コマンドプロンプトから実行するか、`tf.exe`へのパスを環境変数PATHに追加
  - `tf` コマンドが利用できない場合はTFS更新をスキップして比較のみ実行

## インストール

1. `TFS_to_Git_同期ツール.bat` をダウンロード
2. 任意のフォルダに配置（TFSやGitリポジトリと同じ場所でなくてもOK）
3. これで準備完了！

## 使い方

### 1. パスの設定

`TFS_to_Git_同期ツール.bat` をテキストエディタで開き、設定セクションを編集します:

```powershell
#region 設定セクション
# TFSとGitのディレクトリパスを設定（固定値）
# 重要: TFS_DIRとGIT_REPO_DIRは同じフォルダ構造を指すようにしてください
$TFS_DIR = "C:\Users\$env:USERNAME\source"
$GIT_REPO_DIR = "C:\Users\$env:USERNAME\source\Git\project"

# TFS最新取得を実行するか（tfコマンドが利用可能な環境のみ）
$UPDATE_TFS_BEFORE_COMPARE = $true

# 比較対象から除外するファイル（Git固有ファイルなど）
$EXCLUDE_FILES = @(
    ".gitignore",
    ".gitattributes"
)
#endregion
```

**例:**
```powershell
$TFS_DIR = "C:\Work\TFS\MyProject"
$GIT_REPO_DIR = "D:\Repository\MyProject"
$UPDATE_TFS_BEFORE_COMPARE = $true  # TFSを最新にしてから比較
```

**除外ファイル設定:**
- `.gitignore`, `.gitattributes` はGit固有ファイルのため、デフォルトで比較対象から除外されます
- これらのファイルがGitにのみ存在しても「削除対象」として表示されません

**空フォルダに作成される.gitignoreの内容:**
```gitignore
# このファイルは空フォルダをGitで管理するために自動生成されました
# This file was auto-generated to keep this empty folder in Git

# このフォルダ内のすべてのファイルを無視（.gitignore自身を除く）
*
!.gitignore
```

**パス設定の重要なポイント:**
- `TFS_DIR` と `GIT_REPO_DIR` は**同じ階層構造**を指す必要があります
- 例: TFSの `C:\TFS\project\src` とGitの `C:\Git\project\src` を比較する場合、両方とも `src` フォルダを指定

### 2. 実行

バッチファイルをダブルクリックするか、コマンドプロンプトから実行:

```cmd
TFS_to_Git_同期ツール.bat
```

### 3. ブランチ確認

現在のGitブランチが表示されます。以下の選択肢から選びます:

```
1. このまま続行
2. ブランチを切り替える

0. 終了
```

### 4. 同期実行

「1」を選択すると、差分チェックと同期が自動実行されます。

### 5. コミット（オプション）

同期完了後、変更をコミットするか選択できます:

```
1. 変更をコミットする
2. 何もせず終了
```

## 実行例

```
========================================
TFS to Git 同期スクリプト
========================================

TFSディレクトリ: C:\Work\TFS\MyProject
Gitディレクトリ: D:\Repository\MyProject

----------------------------------------
現在のGitブランチ:
----------------------------------------
* main
  develop
  feature/new-feature

ブランチ操作を選択してください:
 1. このまま続行
 2. ブランチを切り替える

 0. 終了

選択 (0-2): 1

========================================
同期処理を開始します
========================================

差分チェック中...

=== ファイル差分チェック ===

[更新] src/main.cpp
[新規] include/newfile.h
[更新] README.md

=== Gitのみに存在するファイル (削除対象) ===

[削除] old/deprecated.cpp

========================================
同期完了
========================================

更新/新規ファイル: 3
削除ファイル: 1
変更なし: 150
```

## 注意事項

### エンコーディング

このバッチファイルは **UTF-8（BOMなし）** で保存する必要があります。Shift-JISで保存すると日本語が文字化けします。

### .gitディレクトリ

`.git`ディレクトリ内のファイルは自動的に除外されます。

### 削除処理

Gitにのみ存在するファイルは**自動的に削除**されます。誤って削除されないよう、実行前に確認してください。

### PowerShell実行ポリシー

スクリプトは `-ExecutionPolicy Bypass` で実行されるため、PowerShellの実行ポリシー設定は不要です。

## トラブルシューティング

### Gitがインストールされていません

**エラーメッセージ**:
```
========================================================================
  [エラー] Gitがインストールされていません
========================================================================

このスクリプトを実行するには、Gitがインストールされている必要があります。

Gitのインストール方法:
  1. https://git-scm.com/download/win にアクセス
  2. 「Download for Windows」をクリック
  3. インストーラーをダウンロードして実行
  4. インストール後、コマンドプロンプトを再起動
```

**解決方法**:
1. 上記URLからGit for Windowsをダウンロードしてインストール
2. インストール完了後、**新しいコマンドプロンプトを開いて**再実行
   - 重要: インストール前に開いていたコマンドプロンプトでは、Gitが認識されません

**確認方法**:
```cmd
git --version
```

### 文字化けする

- バッチファイルがUTF-8で保存されているか確認してください
- VS Codeで開いて右下の文字コードを確認
- **注**: 最新版ではUTF-8エンコーディングを自動的に正しく読み込みます

### Gitディレクトリが認識されない

- 指定したディレクトリに `.git` フォルダが存在するか確認してください
- `git init` または `git clone` でリポジトリを初期化してください

### PowerShellエラーが出る

- PowerShell 5.1以降がインストールされているか確認:
  ```powershell
  $PSVersionTable.PSVersion
  ```

## ライセンス

MIT License

## 変更履歴

### v1.3.0 (2025-01-16)
- **TFS最新取得機能を追加**
  - 比較前に`tf get /recursive`でTFSワークスペースを自動更新
  - `$UPDATE_TFS_BEFORE_COMPARE`設定で有効/無効を切り替え可能
  - `tf`コマンドが利用できない環境ではスキップ
- **空フォルダ対応を追加**
  - TFSの空フォルダをGitに同期可能に
  - 空フォルダには`.gitignore`ファイルを自動作成（Git_空フォルダ管理ツールと同内容）
- **Gitのみファイル/フォルダの検出を改善**
  - パス比較ロジックを修正
  - フォルダの差分も検出・同期対象に
- **Git固有ファイル除外機能を追加**
  - `.gitignore`, `.gitkeep`, `.gitattributes` を比較対象から除外
  - `$EXCLUDE_FILES`設定でカスタマイズ可能

### v1.2.0 (2025-12-06)
- **エンコーディング問題の完全修正**
  - UTF-8エンコーディングの自動認識機能を追加
  - PowerShellスクリプト内の日本語文字化けを解消
  - Get-Contentに`-Encoding UTF8`パラメータを追加
- **環境変数PATH問題の修正**
  - PowerShell起動時に環境変数PATHを明示的に再読み込み
  - システムレベルとユーザーレベルのPATHを結合
  - gitコマンドが見つからない問題を解消
- **Gitインストール確認機能の追加**
  - スクリプト起動時にGitのインストールを自動確認
  - 未インストール時は分かりやすいエラーメッセージとインストールガイドを表示
  - `Get-Command git`でGitコマンドの存在を確認
- **ユーザー体験の向上**
  - エラーメッセージを日本語化・分かりやすく改善
  - インストール方法を4ステップで明確に表示

### v1.1.1 (2025-12-02)
- **環境変数の衝突を修正**
  - `GIT_DIR` を `GIT_REPO_DIR` に変更（Gitの環境変数と衝突回避）
  - バッチファイルのecho構文を修正
  - PowerShellの文字列リテラルをダブルクォートに統一

### v1.1.0 (2025-12-02)
- **PowerShellロジックを別ファイルに分離**
  - `sync_logic.ps1` を新規作成
  - エスケープ問題を修正
  - エラーハンドリングを改善
  - デバッグが容易に
- バッチファイル内のコードを簡素化
- モジュール構成に変更し、保守性向上

### v1.0.0 (2024-12-01)
- 初回リリース
- TFS→Git同期機能
- ブランチ切り替え機能
- MD5ハッシュによる差分チェック
- UTF-8/日本語対応

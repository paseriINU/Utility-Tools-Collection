# JP1 REST API ジョブ情報取得ツール

JP1/AJS3 Web Console REST APIを使用して、ジョブ/ジョブネットの実行結果詳細を取得するツールです。

## 概要

以下の3段階の処理で確証性を保証しながら実行します：

1. **STEP 1: 存在確認・種別確認** - `DEFINITION` で指定ユニットの存在とジョブ種別を確認
2. **STEP 2: execID取得** - `DEFINITION_AND_STATUS` で実行状態とexecIDを取得
3. **STEP 3: 実行結果詳細取得** - execResultDetails APIで実行結果を取得

### 確証性の保証

| チェック項目 | 終了コード | 説明 |
|-------------|-----------|------|
| ユニット存在確認 | 2 | 指定したユニットが存在しない場合 |
| ユニット種別確認 | 3 | 指定したユニットがジョブではない場合 |
| 実行世代確認 | 4 | 実行履歴が存在しない場合 |

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `JP1_REST_ジョブ情報取得ツール.bat` | メインツール（引数必須） |
| `JP1_ジョブログ取得_サンプル.bat` | 呼び出しサンプル（ファイル保存） |

## 必要な環境

- Windows（PowerShell 5.1以降）
- JP1/AJS3 - Web Console がインストール・起動されていること
- Web Console への接続権限（JP1ユーザー）

## 特徴

| 項目 | 説明 |
|------|------|
| 実行方式 | REST API（Web Console経由） |
| 管理者権限 | 不要 |
| WinRM | 不要 |
| 取得情報 | 実行結果詳細（標準出力・標準エラー出力） |
| 出力形式 | Shift-JIS |

## 使い方

### メインツール

引数にユニットパスを指定して実行します：

```batch
JP1_REST_ジョブ情報取得ツール.bat "/JobGroup/Jobnet"
```

**注意**: 引数なしでは実行できません（エラーになります）。

### サンプルバッチ

1. `JP1_ジョブログ取得_サンプル.bat` を編集：

```batch
rem === ここを編集してください ===
set "UNIT_PATH=/JobGroup/Jobnet/Job1"
```

2. ダブルクリックで実行
3. 結果が `ジョブ開始日時.txt` 形式で保存されます（例: `20250105_153028.txt`）
4. ファイル名にジョブの実際の開始日時が使用されるため、履歴管理が容易です

### 他バッチからの呼び出し

```batch
@echo off
setlocal

rem JP1_REST_ジョブ情報取得ツールを呼び出し
call "C:\path\to\JP1_REST_ジョブ情報取得ツール.bat" "/JobGroup/Jobnet" > result.txt 2>&1

rem 結果を処理
type result.txt
```

## 設定項目

メインツール内の設定セクションを編集してください：

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$webConsoleHost` | Web Consoleサーバーのホスト名 | `localhost` |
| `$webConsolePort` | Web Consoleのポート番号 | `22252` |
| `$useHttps` | HTTPS使用フラグ | `$false` |
| `$managerHost` | JP1/AJS3 Managerのホスト名 | `localhost` |
| `$schedulerService` | スケジューラーサービス名 | `AJSROOT1` |
| `$jp1User` | JP1ユーザー名 | `jp1admin` |
| `$jp1Password` | JP1パスワード | - |
| `$generation` | 世代指定 | `RESULT` |
| `$statusFilter` | ステータスフィルタ | （空欄=全件） |

### 世代指定（generation）

| 値 | 説明 |
|----|------|
| `RESULT` | 直近終了世代（デフォルト・推奨） |
| `STATUS` | 最新世代 |
| `PERIOD` | 期間指定（`$periodBegin`/`$periodEnd`を設定） |

### ステータスフィルタ（statusFilter）

| 値 | 説明 |
|----|------|
| （空欄） | 全件取得 |
| `ABNORMAL` | 異常終了のみ |
| `NORMAL` | 正常終了のみ |
| `RUNNING` | 実行中のみ |

## 使用API

| API | 用途 | STEP |
|-----|------|------|
| ユニット一覧取得API (7.1.1) | 存在確認（DEFINITION） | STEP 1 |
| ユニット一覧取得API (7.1.1) | execID取得（DEFINITION_AND_STATUS） | STEP 2 |
| 実行結果詳細取得API (7.1.3) | 実行結果詳細取得 | STEP 3 |

詳細は [JP1_AJS3_REST_API.md](../../JP1_AJS3_REST_API.md) を参照してください。

## 終了コード（実行順）

| コード | STEP | 説明 |
|--------|------|------|
| 0 | - | 正常終了 |
| 1 | - | 引数エラー（ユニットパスが指定されていない、またはパス形式が不正） |
| 2 | STEP 1 | ユニット未検出（指定したユニットが存在しません） |
| 3 | STEP 1 | ユニット種別エラー（指定したユニットがジョブではありません） |
| 4 | STEP 2 | 実行世代なし（実行履歴が存在しません） |
| 5 | STEP 3 | 5MB超過エラー（実行結果が切り捨てられました） |
| 6 | STEP 3 | 詳細取得エラー（実行結果詳細の取得に失敗） |
| 9 | 全STEP | API接続エラー（各STEPでの接続失敗） |

## 出力形式

- **文字コード**: Shift-JIS
- **形式**:
  - 1行目: `START_TIME:yyyyMMdd_HHmmss`（ジョブ開始日時）
  - 2行目以降: 実行結果詳細のテキスト出力
- **エラー時**: `ERROR:` で始まるメッセージを出力

### 出力例

```
START_TIME:20250105_153028
（実行結果詳細の内容）
```

### START_TIMEの活用

呼び出し側でジョブ開始日時をファイル名に使用できます：

```batch
for /f "tokens=1,* delims=:" %%a in ('JP1_REST_ジョブ情報取得ツール.bat "/path"') do (
    if "%%a"=="START_TIME" set "JOB_START_TIME=%%b"
)
echo ファイル名: log_%JOB_START_TIME%.txt
```

## 注意事項

- JP1/AJS3 - Web Console が必要です
- パスワードはスクリプト内に平文で記載されます（セキュリティに注意）
- メインツールは単体では実行できません（引数必須）

## 関連ツール

| ツール | 説明 |
|--------|------|
| [JP1 ジョブツール](../JP1_ジョブツール/) | ajsshowコマンドでジョブ情報取得（WinRM経由） |
| [JP1 ジョブログ取得ツール](../JP1_ジョブログ取得ツール/) | jpqjobgetコマンドでスプール取得 |

## トラブルシューティング

### 接続できない

- Web Consoleサービスが起動しているか確認してください
- ファイアウォールでポートがブロックされていないか確認してください
- ホスト名・ポート番号が正しいか確認してください

### 認証エラー

- JP1ユーザー名・パスワードが正しいか確認してください
- JP1ユーザーに参照権限があるか確認してください

### ユニットが取得できない

- ユニットパスが正しいか確認してください（`/`から始まるフルパス）
- 実行履歴が存在するか確認してください
- `generation=RESULT` で終了済みジョブを対象にしているか確認してください

### 結果が空

- 指定したユニットにジョブ（JOB）が含まれているか確認してください
- ジョブネット直下のジョブのみが対象です

## ライセンス

MIT License

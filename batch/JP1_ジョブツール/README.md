# JP1 ジョブツール

JP1/AJS3 Web Console REST APIを使用して、ジョブの実行とログ取得を行うツールです。

## 概要

2つのツールを提供します：

1. **JP1_REST_ジョブ実行ツール.bat** - ジョブを即時実行してログを取得
2. **JP1_REST_ジョブログ取得ツール.bat** - 実行せずに既存の結果を取得

また、サンプルバッチ（JP1_ジョブツール_サンプル.bat）を使って簡単に呼び出すことができます。

## 必要な環境

- Windows（PowerShell 5.1以降）
- JP1/AJS3 - Web Console（REST API）

## 特徴

| 項目 | 説明 |
|------|------|
| 実行方式 | REST API（JP1/AJS3 Web Console経由） |
| 管理者権限 | 不要 |
| 認証方式 | Windows資格情報マネージャー対応 |
| 比較モード | 2つのジョブを比較して新しい方を取得（GET版） |
| Excel貼り付け | ログをExcelファイルに自動貼り付け（オプション） |

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `JP1_REST_ジョブ実行ツール.bat` | ジョブを即時実行してログを取得（メインツール） |
| `JP1_REST_ジョブログ取得ツール.bat` | 実行せずに既存の結果を取得（メインツール） |
| `JP1_ジョブツール_サンプル.bat` | サンプルバッチ（両ツールを呼び出し、ファイル保存・メモ帳表示） |
| `README.md` | このファイル |

## 使い方

### サンプルバッチを使用する場合

1. `JP1_ジョブツール_サンプル.bat` を編集

```batch
rem モード設定（EXEC=実行, GET=取得）
set "MODE=GET"

rem ジョブパス
set "UNIT_PATH=/JobGroup/Jobnet/Job1"

rem === Excel貼り付け設定（オプション）===
rem Excelファイル名（このバッチと同じフォルダに配置）
set "EXCEL_FILE_NAME=ログ貼り付け用.xlsx"
rem 貼り付け先シート名
set "EXCEL_SHEET_NAME=Sheet1"
rem 貼り付け先セル位置
set "EXCEL_PASTE_CELL=A1"
```

2. バッチファイルをダブルクリックで実行

3. 結果がテキストファイルに保存され、メモ帳で自動表示

4. Excel設定がある場合は、指定したExcelファイルにもログを貼り付け

### メインツールを直接使用する場合

```batch
rem 実行してログ取得
JP1_REST_ジョブ実行ツール.bat "/JobGroup/Jobnet/Job1"

rem 実行せずにログ取得
JP1_REST_ジョブログ取得ツール.bat "/JobGroup/Jobnet/Job1"

rem 2つのジョブを比較して新しい方を取得（GET版のみ）
JP1_REST_ジョブログ取得ツール.bat "/JobGroup/Jobnet/Job1" "/JobGroup/Jobnet/Job2"
```

## 設定項目

メインツールの設定セクションを編集します：

### 接続設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$webConsoleHost` | Web Consoleサーバーのホスト名 | `localhost` |
| `$webConsolePort` | Web Consoleのポート番号 | `22252` |
| `$useHttps` | HTTPS使用フラグ | `$false` |
| `$managerHost` | JP1/AJS3 Managerのホスト名 | `localhost` |
| `$schedulerService` | スケジューラーサービス名 | `AJSROOT1` |

### 認証設定

| 設定項目 | 説明 |
|---------|------|
| `$jp1User` | JP1ユーザー名（空欄で資格情報マネージャーから取得） |
| `$jp1Password` | JP1パスワード（空欄で資格情報マネージャーから取得） |
| `$credentialTarget` | 資格情報マネージャーのターゲット名 |

事前に資格情報を登録する場合：
```cmd
cmdkey /generic:JP1_WebConsole /user:jp1admin /pass:yourpassword
```

### 実行設定（EXEC版のみ）

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$timeoutSeconds` | タイムアウト（秒） | `3600` |
| `$pollIntervalSeconds` | ステータス確認間隔（秒） | `5` |

### 検索条件設定（GET版のみ）

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$generation` | 世代指定（RESULT, STATUS, PERIOD, EXECID） | `RESULT` |
| `$statusFilter` | ユニット状態フィルタ | `NO` |
| `$delayStatus` | 遅延状態フィルタ | `NO` |
| `$holdPlan` | 保留予定フィルタ | `NO` |

## 終了コード

| コード | 説明 |
|-------|------|
| 0 | 正常終了 |
| 1 | 引数エラー |
| 2 | ユニット未検出 |
| 3 | ユニット種別エラー |
| 4 | ルートジョブネット特定エラー / 実行世代なし |
| 5 | 即時実行登録エラー / 5MB超過エラー |
| 6 | タイムアウト / 詳細取得エラー |
| 7 | 5MB超過エラー（EXEC版のみ） |
| 8 | 詳細取得エラー（EXEC版） / 比較モードで両方取得失敗（GET版） |
| 9 | API接続エラー |
| 10 | 比較モードで実行中のジョブが検出された（GET版のみ） |

## 出力形式

メタデータ行（サンプルバッチで使用）：

```
START_TIME:20251010_163520
END_STATUS:正常終了
JOBNET_NAME:Jobnet
JOBNET_COMMENT:テスト用
JOB_STATUS:NORMAL
（実行結果詳細）
```

ファイル名形式（サンプルバッチで生成）：
```
【ジョブ実行結果】【20251010_163520実行分】【正常終了】Jobnet_テスト用.txt
```

## 関連ツール

| ツール | 説明 |
|--------|------|
| [JP1 REST ジョブ実行ログ取得ツール](../JP1_REST_ジョブ実行ログ取得ツール/) | 実行ログ取得専用ツール |
| [JP1 REST ジョブ情報取得ツール](../JP1_REST_ジョブ情報取得ツール/) | 情報取得専用ツール |

## 注意事項

- JP1/AJS3 - Web Consoleが必要です
- 実行権限のあるJP1ユーザーが必要です
- ジョブパスは `/` から始まるフルパスで指定してください
- 実行結果詳細は最大5MBまで取得可能です

## トラブルシューティング

### API接続エラーが発生する

- Web Consoleが起動しているか確認してください
- 接続設定（ホスト名・ポート）を確認してください
- 認証情報（ユーザー名・パスワード）を確認してください

### ユニット未検出と表示される

- ユニットパスが正しいか確認してください
- スケジューラーサービス名が正しいか確認してください
- JP1ユーザーに参照権限があるか確認してください

### 5MB超過エラーが発生する

- 対象ジョブの出力サイズが5MBを超えています
- 出力サイズを削減するか、ajsshowコマンドを直接使用してください

## ライセンス

MIT License

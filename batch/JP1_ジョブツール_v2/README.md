# JP1 ジョブツール v2

JP1/AJS3 Web Console REST APIを使用して、ジョブの実行とログ取得を行うツールです。

## v1からの変更点

- **出力オプション引数を追加**: メインツールに出力方法を指定可能
- **標準ログバッチを簡素化**: ジョブパスと出力オプションを設定するだけ
- **出力先を統一**: `..\02_output\` フォルダに自動出力

## 概要

2つのメインツールを提供します：

1. **JP1ジョブ実行情報取得.bat** - ジョブを即時実行してログを取得
2. **JP1ジョブ情報取得.bat** - 実行せずに既存の結果を取得

## ファイル構成

| ファイル | 説明 |
|---------|------|
| `JP1ジョブ実行情報取得.bat` | メインツール（実行+ログ取得） |
| `JP1ジョブ情報取得.bat` | メインツール（ログ取得のみ） |
| `【JP1ジョブ実行情報取得】ジャーナル取得.bat` | 標準ログバッチ（実行+ジャーナル取得・Excel出力） |
| `【JP1ジョブ情報取得】ジャーナル取得.bat` | 標準ログバッチ（取得専用・Excel出力） |
| `【JP1ジョブ実行情報取得】ジョブ.bat` | 標準ログバッチ（実行専用） |
| `【JP1ジョブ情報取得】ジョブ.bat` | 標準ログバッチ（取得専用） |
| `バッチ→PowerShell変換ツール.bat` | バッチファイルをPowerShellに変換する補助ツール |

## 使い方

### 標準ログバッチを使用する場合

1. 標準ログバッチ（例：`【JP1ジョブ情報取得】ジョブ.bat`）を開く

2. ジョブパスと出力オプションを編集：

```batch
rem ジョブパス（必須）
set "UNIT_PATH=/JobGroup/Jobnet/Job1"

rem 出力オプション
set "OUTPUT_MODE=/NOTEPAD"
```

3. バッチをダブルクリックで実行

### メインツールを直接使用する場合

```batch
rem 実行してログ取得（メモ帳で開く）
JP1ジョブ実行情報取得.bat "/JobGroup/Jobnet/Job1" /NOTEPAD

rem ログ取得のみ（メモ帳で開く）
JP1ジョブ情報取得.bat "/JobGroup/Jobnet/Job1" "" /NOTEPAD

rem 2つのジョブを比較（メモ帳で開く）
JP1ジョブ情報取得.bat "/JobGroup/Jobnet/Job1" "/JobGroup/Jobnet/Job2" /NOTEPAD
```

## 出力オプション

| オプション | 説明 |
|-----------|------|
| `/NOTEPAD` | メモ帳で開く（デフォルト） |
| `/EXCEL` | Excelに貼り付け |
| `/WINMERGE` | WinMergeでキーワード抽出比較 |

### WinMerge比較設定（/WINMERGEオプション使用時）

`/WINMERGE`オプションでは、ログファイルからキーワード間のテキストを抽出し比較します：

| 抽出範囲 | 出力ファイル |
|---------|-------------|
| `#パッチ適用前チェック` ～ `#パッチ適用` | `_データパッチ前.txt` |
| `#パッチ適用後チェック` ～ `#トランザクション処理` | `_データパッチ後.txt` |

キーワードが見つからない場合は、元のログファイルをWinMergeで開きます。

### Excel貼り付け設定（/EXCELオプション使用時）

`/EXCEL`オプションを使用する場合は、メインツール（JP1ジョブ実行情報取得.bat / JP1ジョブ情報取得.bat）の設定セクションを編集してください：

```powershell
# Excel貼り付け設定（/EXCEL オプション使用時）
# フルパスまたは相対パス（バッチと同じフォルダからの相対パス）で指定
$excelFileNameSetting = "ログ貼り付け用.xlsx"
$excelSheetNameSetting = "Sheet1"
$excelPasteCellSetting = "A1"
```

**注意**: `/EXCEL`オプション使用時にこれらの設定が空の場合、エラー（終了コード10）で終了します。

## 出力先

```
親フォルダ/
├── 01.Batch/           <- バッチファイルの配置場所
│   ├── JP1ジョブ実行情報取得.bat
│   ├── JP1ジョブ情報取得.bat
│   └── ...
└── 02_output/          <- 出力先（自動作成）
    └── 【ジョブ実行結果】【YYYYMMDD_HHMMSS実行分】【終了状態】ジョブネット名_コメント.txt
```

## 必要な環境

- Windows（PowerShell 5.1以降）
- JP1/AJS3 - Web Console（REST API）

## 設定項目

メインツール（JP1ジョブ実行情報取得.bat / JP1ジョブ情報取得.bat）の設定セクションを編集：

### 接続設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| `$webConsoleHost` | Web Consoleサーバーのホスト名 | `localhost` |
| `$webConsolePort` | Web Consoleのポート番号 | `22252` |
| `$schedulerService` | スケジューラーサービス名 | `AJSROOT1` |

### 認証設定

事前に資格情報を登録する場合：
```cmd
cmdkey /generic:JP1_WebConsole /user:jp1admin /pass:yourpassword
```

## 終了コード

| コード | 説明 |
|-------|------|
| 0 | 正常終了 |
| 1 | 引数エラー |
| 2 | ユニット未検出 |
| 3 | ユニット種別エラー |
| 4 | ルートジョブネット特定エラー / 実行世代なし |
| 5 | 即時実行登録エラー / 5MB超過エラー |
| 6 | タイムアウト / 詳細取得エラー |
| 8 | 詳細取得エラー / 比較モードで両方取得失敗 |
| 9 | API接続エラー |
| 10 | Excel設定エラー（設定が未入力） |
| 11 | Excel貼り付けエラー |
| 12 | Excelファイル未検出 |

## ライセンス

MIT License

# TFS to Git Sync Script

TFS（Team Foundation Server）のローカルディレクトリとGitリポジトリを同期するWindowsバッチスクリプトです。

## 機能

- ✅ **高速な差分チェック**: PowerShellとMD5ハッシュで大量のファイルを効率的に処理
- ✅ **自動同期**: TFS→Gitへファイル更新・新規追加・削除を自動実行
- ✅ **Gitブランチ管理**: 実行前にブランチ確認・切り替えが可能
- ✅ **日本語対応**: UTF-8モードで日本語のブランチ名・ファイル名に対応
- ✅ **コミット機能**: 同期後にオプションでGitコミット可能
- ✅ **モジュール構成**: PowerShellロジックを別ファイルに分離し、保守性向上

## 動作の流れ

1. TFSとGitのディレクトリ内のファイルを再帰的にスキャン
2. MD5ハッシュでファイルの差分をチェック
3. 以下の3つの処理を実行:
   - **更新**: TFSとGitで内容が異なるファイルをコピー
   - **新規追加**: TFSにのみ存在するファイルをコピー
   - **削除**: Gitにのみ存在するファイルを削除
4. 処理結果を統計表示（更新/新規/削除/変更なしの件数）
5. オプションでGitコミット

## ファイル構成

```
batch/sync/
├── sync_tfs_to_git.bat   # メインのバッチスクリプト（UI・制御）
├── sync_logic.ps1         # PowerShell同期ロジック
└── README.md              # このファイル
```

## 必要な環境

- Windows 10/11
- PowerShell 5.1以降（Windows標準で搭載）
- Git for Windows

## インストール

1. `batch/sync/` フォルダ全体をダウンロード
   - `sync_tfs_to_git.bat`（メインスクリプト）
   - `sync_logic.ps1`（PowerShellロジック）
2. **UTF-8エンコーディングで保存されていることを確認**
   - VS Code: 右下の文字コード部分をクリック → UTF-8
   - メモ帳: 名前を付けて保存 → エンコード: UTF-8
3. **2つのファイルを同じフォルダに配置**
   - バッチファイルが同じディレクトリの `.ps1` を自動検出します

## 使い方

### 1. パスの設定

バッチファイルの20-21行目を編集します:

```batch
set "TFS_DIR=C:\Path\To\TFS\Project"
set "GIT_REPO_DIR=C:\Path\To\Git\Project"
```

**例:**
```batch
set "TFS_DIR=C:\Work\TFS\MyProject"
set "GIT_REPO_DIR=D:\Repository\MyProject"
```

**注意:** 変数名は`GIT_REPO_DIR`を使用してください（`GIT_DIR`はGitの環境変数と衝突します）

### 2. 実行

バッチファイルをダブルクリックするか、コマンドプロンプトから実行:

```cmd
sync_tfs_to_git.bat
```

### 3. ブランチ確認

現在のGitブランチが表示されます。以下の選択肢から選びます:

```
1. このまま続行
2. ブランチを切り替える
3. 終了
```

### 4. 同期実行

「1」を選択すると、差分チェックと同期が自動実行されます。

### 5. コミット（オプション）

同期完了後、変更をコミットするか選択できます:

```
1. 変更をコミットする
2. 何もせず終了
```

## 実行例

```
========================================
TFS to Git 同期スクリプト
========================================

TFSディレクトリ: C:\Work\TFS\MyProject
Gitディレクトリ: D:\Repository\MyProject

----------------------------------------
現在のGitブランチ:
----------------------------------------
* main
  develop
  feature/new-feature

ブランチ操作を選択してください:
1. このまま続行
2. ブランチを切り替える
3. 終了

選択 (1-3): 1

========================================
同期処理を開始します
========================================

差分チェック中...

=== ファイル差分チェック ===

[更新] src/main.cpp
[新規] include/newfile.h
[更新] README.md

=== Gitのみに存在するファイル (削除対象) ===

[削除] old/deprecated.cpp

========================================
同期完了
========================================

更新/新規ファイル: 3
削除ファイル: 1
変更なし: 150
```

## 注意事項

### エンコーディング

このバッチファイルは **UTF-8（BOMなし）** で保存する必要があります。Shift-JISで保存すると日本語が文字化けします。

### .gitディレクトリ

`.git`ディレクトリ内のファイルは自動的に除外されます。

### 削除処理

Gitにのみ存在するファイルは**自動的に削除**されます。誤って削除されないよう、実行前に確認してください。

### PowerShell実行ポリシー

スクリプトは `-ExecutionPolicy Bypass` で実行されるため、PowerShellの実行ポリシー設定は不要です。

## トラブルシューティング

### 文字化けする

- バッチファイルがUTF-8で保存されているか確認してください
- VS Codeで開いて右下の文字コードを確認

### Gitディレクトリが認識されない

- 指定したディレクトリに `.git` フォルダが存在するか確認してください
- `git init` または `git clone` でリポジトリを初期化してください

### PowerShellエラーが出る

- PowerShell 5.1以降がインストールされているか確認:
  ```powershell
  $PSVersionTable.PSVersion
  ```

## ライセンス

MIT License

## 変更履歴

### v1.1.1 (2025-12-02)
- **環境変数の衝突を修正**
  - `GIT_DIR` を `GIT_REPO_DIR` に変更（Gitの環境変数と衝突回避）
  - バッチファイルのecho構文を修正
  - PowerShellの文字列リテラルをダブルクォートに統一

### v1.1.0 (2025-12-02)
- **PowerShellロジックを別ファイルに分離**
  - `sync_logic.ps1` を新規作成
  - エスケープ問題を修正
  - エラーハンドリングを改善
  - デバッグが容易に
- バッチファイル内のコードを簡素化
- モジュール構成に変更し、保守性向上

### v1.0.0 (2024-12-01)
- 初回リリース
- TFS→Git同期機能
- ブランチ切り替え機能
- MD5ハッシュによる差分チェック
- UTF-8/日本語対応
